<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plano de Leitura 2026 (Checklist)</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121926;
      --card2:#0f1623;
      --text:#e8eef6;
      --muted:#a9b6c6;
      --line:#223047;
      --ok:#2ee59d;
      --warn:#ffcc66;
      --accent:#7aa7ff;
      --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #101a2a 0%, var(--bg) 60%);
      color:var(--text);
    }
    header{
      padding:20px 16px 12px 16px;
      max-width:1100px;
      margin:0 auto;
    }
    .title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }
    h1{
      margin:0 0 6px 0;
      font-size:22px;
      letter-spacing:0.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.4;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      background:rgba(122,167,255,0.12);
      border:1px solid rgba(122,167,255,0.25);
      border-radius:12px;
      color:var(--text);
      font-size:13px;
      white-space:nowrap;
    }

    main{max-width:1100px;margin:0 auto;padding:0 16px 110px 16px;} /* + espa√ßo para barra mobile */

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.08);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:16px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    label.small{font-size:12px;color:var(--muted)}
    select, input[type="date"]{
      background: var(--card2);
      color:var(--text);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
    }

    button{
      cursor:pointer;
      background: rgba(122,167,255,0.14);
      color: var(--text);
      border: 1px solid rgba(122,167,255,0.26);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight:700;
      letter-spacing:0.2px;
    }
    button:hover{filter:brightness(1.08)}
    button.secondary{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      font-weight:650;
    }
    button.danger{
      background: rgba(255,107,107,0.16);
      border:1px solid rgba(255,107,107,0.32);
    }
    button.ok{
      background: rgba(46,229,157,0.14);
      border:1px solid rgba(46,229,157,0.28);
    }

    .stat{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .kpi{
      flex:1;
      min-width:220px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.2);
    }
    .kpi .k{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:20px;font-weight:800;margin-top:3px}
    .bar{
      height:10px;
      background: rgba(255,255,255,0.08);
      border-radius:999px;
      overflow:hidden;
      margin-top:10px;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--ok));
      border-radius:999px;
      transition: width .2s ease;
    }

    details{
      margin-top:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.18);
      overflow:hidden;
    }
    summary{
      list-style:none;
      padding:14px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    summary::-webkit-details-marker{display:none}
    .monthTitle{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.14);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(255,255,255,0.06);
      white-space:nowrap;
    }
    .monthBody{padding:0 14px 14px 14px;}
    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.08);
    }
    th, td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,0.07);
      vertical-align:top;
      font-size:13px;
    }
    th{
      color:var(--muted);
      font-weight:700;
      background: rgba(255,255,255,0.04);
    }
    tr:last-child td{border-bottom:none;}
    .dayCell{white-space:nowrap;color:var(--muted);font-weight:800;}
    .readCell{font-weight:650}
    .note{
      width:100%;
      min-height:38px;
      resize:vertical;
      background: rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:10px;
      color: var(--text);
      padding:8px;
      outline:none;
    }
    .checkWrap{
      display:flex;
      align-items:center;
      gap:10px;
    }
    input[type="checkbox"]{
      width:18px;height:18px;
      accent-color: var(--ok);
      cursor:pointer;
    }
    .today{
      outline:2px solid rgba(255,204,102,0.35);
      outline-offset:-2px;
      background: rgba(255,204,102,0.06);
    }
    .muted{color:var(--muted)}
    .tiny{font-size:12px;color:var(--muted)}
    .footer{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .fileInput{display:none;}

    a.link{
      color: var(--accent);
      text-decoration:none;
      font-weight:700;
    }
    a.link:hover{ text-decoration:underline; }

    /* ===== Barra de a√ß√µes mobile (bem vis√≠vel) ===== */
    .actionBar{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px 14px 12px;
      background: rgba(10,15,20,0.92);
      border-top: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(10px);
      z-index:999;
    }
    .actionBar .wrap{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .actionBar .btnBig{
      flex:1;
      min-width: 190px;
      padding:14px 14px;
      border-radius:14px;
      font-size:14px;
    }
    .actionBar .hint{
      width:100%;
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      line-height:1.3;
    }
    @media (min-width: 981px){
      .actionBar{ /* no desktop, mant√©m mas um pouco menor */
        padding:8px 12px 10px 12px;
      }
      .actionBar .btnBig{
        max-width: 340px;
        flex:0 1 auto;
        padding:12px 14px;
      }
      main{padding-bottom:90px;}
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div>
        <h1>Plano de Leitura 2026 (Checklist)</h1>
        <p class="subtitle">
          Leia e marque ‚úÖ. Use <b>üìñ Iniciar leitura de hoje</b> para abrir no <b>B√≠blia Online</b> e depois
          <b>‚úÖ Finalizei</b> para marcar o dia.
        </p>
      </div>
      <div class="pill">üìÖ 2026 ‚Ä¢ ‚úÖ Progresso salvo automaticamente</div>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <h2>Configura√ß√£o</h2>

        <div class="row">
          <div>
            <label class="small">Data de in√≠cio do plano</label><br/>
            <input type="date" id="startDate" />
          </div>

          <div>
            <label class="small">Tradu√ß√£o (B√≠blia Online)</label><br/>
            <select id="versionSelect" title="Tradu√ß√£o">
              <option value="acf">ACF</option>
              <option value="ara">ARA</option>
              <option value="arc">ARC</option>
              <option value="naa">NAA</option>
              <option value="nvi">NVI</option>
            </select>
          </div>

          <div style="flex:1"></div>

          <button class="secondary" id="openTodayBtn">Abrir m√™s de hoje</button>
          <button id="regenBtn">Recalcular plano</button>
        </div>

        <p class="tiny" style="margin:10px 0 0 0">
          üìù Dica: se perder um dia, s√≥ continue. O checklist n√£o √© cobran√ßa ‚Äî √© const√¢ncia.
        </p>

        <div class="stat">
          <div class="kpi">
            <div class="k">Progresso do ano</div>
            <div class="v" id="yearProgressText">0/365</div>
            <div class="bar"><div id="yearBar"></div></div>
          </div>
          <div class="kpi">
            <div class="k">Dias consecutivos (streak)</div>
            <div class="v" id="streakText">0</div>
            <div class="tiny muted">Marca√ß√µes em sequ√™ncia at√© hoje</div>
          </div>
        </div>

        <div class="footer">
          <div class="row">
            <button class="secondary" id="exportBtn">Exportar backup (JSON)</button>
            <button class="secondary" id="importBtn">Importar backup (JSON)</button>
            <input class="fileInput" id="importFile" type="file" accept="application/json" />
          </div>
          <button class="danger" id="resetBtn">Zerar marca√ß√µes</button>
        </div>
      </section>

      <section class="card">
        <h2>Como usar (bem simples)</h2>
        <ul class="tiny" style="margin:8px 0 0 18px; line-height:1.7">
          <li>Todo dia tem leitura do <b>AT</b> e do <b>NT</b>.</li>
          <li>Para fechar o <b>AT em 1 ano</b>, alguns dias t√™m <b>2 cap√≠tulos</b> e outros <b>3</b>.</li>
          <li>O <b>NT</b> fica em <b>1 cap√≠tulo/dia</b>. Ao terminar, ele reinicia (b√¥nus ‚Äî voc√™ l√™ o NT mais de 1 vez).</li>
          <li>Use os bot√µes do rodap√© no celular: <b>üìñ Iniciar</b> ‚Üí l√™ ‚Üí <b>‚úÖ Finalizei</b> para marcar.</li>
        </ul>
        <p class="tiny muted" style="margin-top:10px">
          Se quiser depois, a gente ajusta para um modelo ‚ÄúB√≠blia completa 100% certinho‚Äù (sem reiniciar NT).
        </p>
      </section>
    </div>

    <div id="months"></div>
  </main>

  <!-- Barra de a√ß√µes (mobile first) -->
  <div class="actionBar">
    <div class="wrap">
      <button class="btnBig" id="startTodayReadingBtn">üìñ Iniciar leitura de hoje</button>
      <button class="btnBig ok" id="finishTodayBtn">‚úÖ Finalizei a leitura de hoje</button>
      <div class="hint" id="todayHint">Hoje: ‚Äî</div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG PADR√ÉO
  // =========================
  const YEAR = 2026;
  const DEFAULT_START_DATE = "2026-01-06"; // voc√™ disse que o plano come√ßou dia 6

  // 4 dias com 3 cap√≠tulos OT + 3 dias com 2 cap√≠tulos OT (m√©dia ~2,57/dia => fecha OT em 1 ano)
  const OT_CHAPTERS_PATTERN = [3,3,2,3,3,2,2];

  // =========================
  // LIVROS (cap√≠tulos)
  // =========================
  const OT = [
    ["G√™nesis",50],["√äxodo",40],["Lev√≠tico",27],["N√∫meros",36],["Deuteron√¥mio",34],
    ["Josu√©",24],["Ju√≠zes",21],["Rute",4],["1 Samuel",31],["2 Samuel",24],
    ["1 Reis",22],["2 Reis",25],["1 Cr√¥nicas",29],["2 Cr√¥nicas",36],["Esdras",10],
    ["Neemias",13],["Ester",10],["J√≥",42],["Salmos",150],["Prov√©rbios",31],
    ["Eclesiastes",12],["Cantares",8],["Isa√≠as",66],["Jeremias",52],["Lamenta√ß√µes",5],
    ["Ezequiel",48],["Daniel",12],["Os√©ias",14],["Joel",3],["Am√≥s",9],
    ["Obadias",1],["Jonas",4],["Miqu√©ias",7],["Naum",3],["Habacuque",3],
    ["Sofonias",3],["Ageu",2],["Zacarias",14],["Malaquias",4]
  ];

  const NT = [
    ["Mateus",28],["Marcos",16],["Lucas",24],["Jo√£o",21],["Atos",28],
    ["Romanos",16],["1 Cor√≠ntios",16],["2 Cor√≠ntios",13],["G√°latas",6],["Ef√©sios",6],
    ["Filipenses",4],["Colossenses",4],["1 Tessalonicenses",5],["2 Tessalonicenses",3],
    ["1 Tim√≥teo",6],["2 Tim√≥teo",4],["Tito",3],["Filemom",1],["Hebreus",13],
    ["Tiago",5],["1 Pedro",5],["2 Pedro",3],["1 Jo√£o",5],["2 Jo√£o",1],
    ["3 Jo√£o",1],["Judas",1],["Apocalipse",22]
  ];

  // =========================
  // B√çBLIA ONLINE (c√≥digos de livros)
  // URL padr√£o: https://www.bibliaonline.com.br/{versao}/{codigo}/{capitulo}
  // Exemplo: https://www.bibliaonline.com.br/acf/gn/1 :contentReference[oaicite:0]{index=0}
  // =========================
  const BO_BOOK_CODE = {
    // OT
    "G√™nesis":"gn","√äxodo":"ex","Lev√≠tico":"lv","N√∫meros":"nm","Deuteron√¥mio":"dt",
    "Josu√©":"js","Ju√≠zes":"jz","Rute":"rt","1 Samuel":"1sm","2 Samuel":"2sm",
    "1 Reis":"1rs","2 Reis":"2rs","1 Cr√¥nicas":"1cr","2 Cr√¥nicas":"2cr","Esdras":"ed",
    "Neemias":"ne","Ester":"et","J√≥":"jo","Salmos":"sl","Prov√©rbios":"pv",
    "Eclesiastes":"ec","Cantares":"ct","Isa√≠as":"is","Jeremias":"jr","Lamenta√ß√µes":"lm",
    "Ezequiel":"ez","Daniel":"dn","Os√©ias":"os","Joel":"jl","Am√≥s":"am",
    "Obadias":"ob","Jonas":"jn","Miqu√©ias":"mq","Naum":"na","Habacuque":"hc",
    "Sofonias":"sf","Ageu":"ag","Zacarias":"zc","Malaquias":"ml",

    // NT
    "Mateus":"mt","Marcos":"mc","Lucas":"lc","Jo√£o":"jo","Atos":"at",
    "Romanos":"rm","1 Cor√≠ntios":"1co","2 Cor√≠ntios":"2co","G√°latas":"gl","Ef√©sios":"ef",
    "Filipenses":"fp","Colossenses":"cl","1 Tessalonicenses":"1ts","2 Tessalonicenses":"2ts",
    "1 Tim√≥teo":"1tm","2 Tim√≥teo":"2tm","Tito":"tt","Filemom":"fm","Hebreus":"hb",
    "Tiago":"tg","1 Pedro":"1pe","2 Pedro":"2pe","1 Jo√£o":"1jo","2 Jo√£o":"2jo",
    "3 Jo√£o":"3jo","Judas":"jd","Apocalipse":"ap"
  };

  function bibleOnlineUrl(version, bookName, chapterNumber){
    const code = BO_BOOK_CODE[bookName];
    if (!code) return null;
    return `https://www.bibliaonline.com.br/${version}/${code}/${chapterNumber}`;
  }

  // =========================
  // UTIL
  // =========================
  const pad2 = (n)=> String(n).padStart(2,"0");

  function ymd(date){
    return `${date.getFullYear()}-${pad2(date.getMonth()+1)}-${pad2(date.getDate())}`;
  }

  function parseYMD(s){
    const [Y,M,D] = s.split("-").map(Number);
    return new Date(Y, M-1, D);
  }

  function daysBetween(a,b){
    const ms = 24*60*60*1000;
    const aa = new Date(a.getFullYear(),a.getMonth(),a.getDate()).getTime();
    const bb = new Date(b.getFullYear(),b.getMonth(),b.getDate()).getTime();
    return Math.floor((bb-aa)/ms);
  }

  function totalChapters(list){
    return list.reduce((acc,[,c])=>acc+c,0);
  }

  const OT_TOTAL = totalChapters(OT); // 929
  const NT_TOTAL = totalChapters(NT); // 260

  function chapterAt(globalIndex, list){
    let idx = globalIndex;
    for (const [book, count] of list){
      if (idx < count){
        return { book, chapter: idx+1 };
      }
      idx -= count;
    }
    // se passar do fim, reinicia (ciclo)
    const total = totalChapters(list);
    idx = ((globalIndex % total)+total)%total;
    return chapterAt(idx, list);
  }

  function nextNChaptersText(startIndex, n, list){
    const parts = [];
    let i = startIndex;

    while (n > 0){
      const start = chapterAt(i, list);
      const bookEntry = list.find(b => b[0] === start.book);
      const bookCount = bookEntry ? bookEntry[1] : 1;

      const withinBookStart = start.chapter;
      const remainingInBook = bookCount - withinBookStart + 1;
      const take = Math.min(n, remainingInBook);

      const endChapter = withinBookStart + take - 1;

      if (take === 1){
        parts.push(`${start.book} ${withinBookStart}`);
      } else {
        parts.push(`${start.book} ${withinBookStart}‚Äì${endChapter}`);
      }

      i += take;
      n -= take;
    }

    return parts.join("; ");
  }

  function nextNChaptersList(startIndex, n, list){
    const chapters = [];
    for (let i = 0; i < n; i++){
      chapters.push(chapterAt(startIndex + i, list));
    }
    return chapters;
  }

  // =========================
  // STORAGE
  // =========================
  const KEY = "planoLeitura2026_v2";

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      return raw ? JSON.parse(raw) : { startDate: DEFAULT_START_DATE, version: "acf", days: {} };
    }catch{
      return { startDate: DEFAULT_START_DATE, version: "acf", days: {} };
    }
  }

  function saveState(state){
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  function ensureStateDefaults(state){
    if (!state.startDate) state.startDate = DEFAULT_START_DATE;
    if (!state.version) state.version = "acf";
    if (!state.days) state.days = {};
    return state;
  }

  // =========================
  // PLANO / GERA√á√ÉO
  // =========================
  const monthNames = [
    "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
  ];

  function monthKey(m){ return `m-${YEAR}-${pad2(m+1)}`; }

  function buildPlanForYear(startDateStr){
    const startDate = parseYMD(startDateStr);

    let otPos = 0;
    let ntPos = 0;

    const plan = {};

    const yearStart = new Date(YEAR,0,1);
    const yearEnd = new Date(YEAR,11,31);

    for (let d = new Date(yearStart); d <= yearEnd; d.setDate(d.getDate()+1)){
      const key = ymd(d);

      if (d < startDate){
        plan[key] = { otText: "‚Äî", ntText: "‚Äî", otList: [], ntList: [], active:false };
        continue;
      }

      const offset = daysBetween(startDate, d);
      const otN = OT_CHAPTERS_PATTERN[offset % 7];
      const ntN = 1;

      const otList = nextNChaptersList(otPos, otN, OT);
      const ntList = nextNChaptersList(ntPos, ntN, NT);

      const otText = nextNChaptersText(otPos, otN, OT);
      const ntText = nextNChaptersText(ntPos, ntN, NT);

      plan[key] = { otText, ntText, otList, ntList, active:true };

      otPos += otN;
      ntPos += ntN;

      if (otPos >= OT_TOTAL){
        // ap√≥s fechar OT, fica ‚ÄúRevis√£o‚Äù
        otPos = OT_TOTAL;
      }
      if (ntPos >= NT_TOTAL){
        ntPos = ntPos % NT_TOTAL;
      }
    }

    return plan;
  }

  // =========================
  // ESCAPE helpers
  // =========================
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function cssEscape(id){
    return id.replaceAll(":", "\\:").replaceAll(".", "\\.").replaceAll("/", "\\/");
  }

  // =========================
  // PROGRESS / STREAK
  // =========================
  function calcStreak(state, today){
    let streak = 0;
    let d = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    while (true){
      if (d.getFullYear() !== YEAR) break;
      const key = ymd(d);
      if (state.days?.[key]?.done){
        streak++;
        d.setDate(d.getDate()-1);
      } else break;
    }
    return streak;
  }

  // =========================
  // RENDER
  // =========================
  function renderAll(state){
    state = ensureStateDefaults(state);

    const plan = buildPlanForYear(state.startDate);
    const container = document.getElementById("months");
    container.innerHTML = "";

    const today = new Date();
    const todayKey = ymd(today);

    // Atualiza hint do rodap√© (hoje)
    updateTodayHint(plan, state, today);

    // Progresso anual
    const yearDays = [];
    const yearStart = new Date(YEAR,0,1);
    const yearEnd = new Date(YEAR,11,31);
    for (let d = new Date(yearStart); d <= yearEnd; d.setDate(d.getDate()+1)){
      yearDays.push(ymd(d));
    }

    const doneCount = yearDays.filter(k => state.days?.[k]?.done).length;
    document.getElementById("yearProgressText").textContent = `${doneCount}/365`;
    document.getElementById("yearBar").style.width = `${Math.round((doneCount/365)*100)}%`;

    const streak = calcStreak(state, today);
    document.getElementById("streakText").textContent = String(streak);

    // Render meses
    for (let m = 0; m < 12; m++){
      const details = document.createElement("details");
      details.id = monthKey(m);
      if (today.getFullYear() === YEAR && today.getMonth() === m) details.open = true;

      const summary = document.createElement("summary");
      const left = document.createElement("div");
      left.className = "monthTitle";
      left.innerHTML = `üìå ${monthNames[m]}`;

      const monthStats = document.createElement("div");
      monthStats.className = "badge";
      monthStats.id = `badge-${m}`;

      summary.appendChild(left);
      summary.appendChild(monthStats);

      const body = document.createElement("div");
      body.className = "monthBody";

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:70px">Dia</th>
            <th>AT</th>
            <th>NT</th>
            <th style="width:170px">Abrir</th>
            <th style="width:120px">Conclu√≠do</th>
            <th>Anota√ß√£o</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector("tbody");

      const lastDay = new Date(YEAR, m+1, 0).getDate();
      let monthDone = 0;

      for (let day = 1; day <= lastDay; day++){
        const date = new Date(YEAR, m, day);
        const key = ymd(date);

        const p = plan[key] || { otText:"‚Äî", ntText:"‚Äî", otList:[], ntList:[], active:false };
        const dayState = state.days[key] || { done:false, note:"" };

        if (dayState.done) monthDone++;

        const tr = document.createElement("tr");
        if (key === todayKey) tr.classList.add("today");

        const doneId = `done-${key}`;
        const noteId = `note-${key}`;

        // Links "Abrir"
        const otFirst = p.otList?.[0];
        const ntFirst = p.ntList?.[0];

        const otUrl = (otFirst && p.active) ? bibleOnlineUrl(state.version, otFirst.book, otFirst.chapter) : null;
        const ntUrl = (ntFirst && p.active) ? bibleOnlineUrl(state.version, ntFirst.book, ntFirst.chapter) : null;

        const openLinks = p.active
          ? `
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              ${otUrl ? `<a class="link" href="${otUrl}" target="_blank" rel="noopener noreferrer">AT</a>` : `<span class="muted">AT</span>`}
              ${ntUrl ? `<a class="link" href="${ntUrl}" target="_blank" rel="noopener noreferrer">NT</a>` : `<span class="muted">NT</span>`}
            </div>
          `
          : `<span class="muted">‚Äî</span>`;

        tr.innerHTML = `
          <td class="dayCell">${day}</td>
          <td class="readCell">${p.otText}${p.active ? "" : " <span class='muted'>(fora do in√≠cio)</span>"}</td>
          <td class="readCell">${p.ntText}${p.active ? "" : ""}</td>
          <td>${openLinks}</td>
          <td>
            <div class="checkWrap">
              <input type="checkbox" id="${doneId}" ${dayState.done ? "checked":""} ${p.active ? "" : "disabled"} />
              <span class="tiny">${p.active ? "Lido" : "‚Äî"}</span>
            </div>
          </td>
          <td>
            <textarea class="note" id="${noteId}" placeholder="Ex.: um vers√≠culo, algo que aprendi...">${escapeHtml(dayState.note || "")}</textarea>
          </td>
        `;

        tbody.appendChild(tr);

        // listeners
        tr.querySelector(`#${cssEscape(doneId)}`).addEventListener("change", (e)=>{
          state.days[key] = state.days[key] || {};
          state.days[key].done = !!e.target.checked;
          saveState(state);
          renderAll(loadState());
        });

        tr.querySelector(`#${cssEscape(noteId)}`).addEventListener("input", (e)=>{
          state.days[key] = state.days[key] || {};
          state.days[key].note = e.target.value;
          saveState(state);
        });
      }

      body.appendChild(table);
      details.appendChild(summary);
      details.appendChild(body);
      container.appendChild(details);

      const monthTotal = lastDay;
      const pct = Math.round((monthDone/monthTotal)*100);
      document.getElementById(`badge-${m}`).textContent = `‚úÖ ${monthDone}/${monthTotal} (${pct}%)`;
    }
  }

  function updateTodayHint(plan, state, today){
    const hint = document.getElementById("todayHint");

    if (today.getFullYear() !== YEAR){
      hint.textContent = `Hoje n√£o √© ${YEAR}. (O checklist √© de ${YEAR})`;
      return;
    }

    const key = ymd(today);
    const p = plan[key];

    if (!p || !p.active){
      hint.textContent = "Hoje est√° fora do per√≠odo ativo do plano (verifique a data de in√≠cio).";
      return;
    }

    const done = !!state.days?.[key]?.done;
    hint.textContent = `Hoje: ${p.otText} | ${p.ntText}${done ? " ‚úÖ" : ""}`;
  }

  // =========================
  // A√á√ïES: Iniciar / Finalizar (HOJE)
  // =========================
  function openChaptersInTabs(version, chapterList){
    // abre cada cap√≠tulo em sua pr√≥pria aba (m√°ximo 3 OT + 1 NT aqui)
    for (const item of chapterList){
      const url = bibleOnlineUrl(version, item.book, item.chapter);
      if (url) window.open(url, "_blank", "noopener,noreferrer");
    }
  }

  function openTodayReading(){
    const state = loadState();
    const plan = buildPlanForYear(state.startDate || DEFAULT_START_DATE);
    const now = new Date();

    if (now.getFullYear() !== YEAR){
      alert(`Este checklist √© de ${YEAR}.`);
      return;
    }

    const key = ymd(now);
    const p = plan[key];

    if (!p || !p.active){
      alert("Hoje est√° fora do intervalo ativo do plano. Verifique a data de in√≠cio.");
      return;
    }

    // abre AT (2-3 cap√≠tulos) e NT (1 cap√≠tulo)
    openChaptersInTabs(state.version, p.otList || []);
    openChaptersInTabs(state.version, p.ntList || []);

    // abre o m√™s de hoje
    const el = document.getElementById(monthKey(now.getMonth()));
    if (el){
      el.open = true;
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }
  }

  function finishTodayReading(){
    const state = loadState();
    const plan = buildPlanForYear(state.startDate || DEFAULT_START_DATE);
    const now = new Date();

    if (now.getFullYear() !== YEAR){
      alert(`Este checklist √© de ${YEAR}.`);
      return;
    }

    const key = ymd(now);
    const p = plan[key];

    if (!p || !p.active){
      alert("Hoje est√° fora do intervalo ativo do plano. Verifique a data de in√≠cio.");
      return;
    }

    state.days[key] = state.days[key] || {};
    state.days[key].done = true;
    saveState(state);

    // abre o m√™s de hoje e atualiza a tela
    const el = document.getElementById(monthKey(now.getMonth()));
    if (el){
      el.open = true;
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }
    renderAll(loadState());
  }

  // =========================
  // CONTROLES
  // =========================
  let state = ensureStateDefaults(loadState());

  const startDateEl = document.getElementById("startDate");
  const versionSelectEl = document.getElementById("versionSelect");

  startDateEl.value = state.startDate || DEFAULT_START_DATE;
  versionSelectEl.value = state.version || "acf";

  document.getElementById("regenBtn").addEventListener("click", ()=>{
    state = loadState();
    state.startDate = startDateEl.value || DEFAULT_START_DATE;
    state.version = versionSelectEl.value || "acf";
    saveState(state);
    renderAll(loadState());
  });

  document.getElementById("openTodayBtn").addEventListener("click", ()=>{
    const t = new Date();
    if (t.getFullYear() !== YEAR){
      alert(`Hoje n√£o √© ${YEAR}. Vou abrir Janeiro/${YEAR}.`);
      const jan = document.getElementById(monthKey(0));
      if (jan) jan.open = true;
      jan?.scrollIntoView({behavior:"smooth", block:"start"});
      return;
    }
    const m = t.getMonth();
    const el = document.getElementById(monthKey(m));
    if (el){
      el.open = true;
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }
  });

  document.getElementById("startTodayReadingBtn").addEventListener("click", openTodayReading);
  document.getElementById("finishTodayBtn").addEventListener("click", finishTodayReading);

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    const ok = confirm("Tem certeza que deseja zerar TODAS as marca√ß√µes e anota√ß√µes? Isso n√£o tem volta.");
    if (!ok) return;
    state = loadState();
    state.days = {};
    saveState(state);
    renderAll(loadState());
  });

  // Export / Import
  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const data = loadState();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "plano-leitura-2026-backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("importBtn").addEventListener("click", ()=>{
    document.getElementById("importFile").click();
  });

  document.getElementById("importFile").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if (!file) return;
    try{
      const text = await file.text();
      const parsed = JSON.parse(text);
      if (!parsed || typeof parsed !== "object") throw new Error("JSON inv√°lido");
      parsed.startDate = parsed.startDate || DEFAULT_START_DATE;
      parsed.version = parsed.version || "acf";
      parsed.days = parsed.days || {};
      localStorage.setItem(KEY, JSON.stringify(parsed));
      state = parsed;
      startDateEl.value = state.startDate;
      versionSelectEl.value = state.version;
      renderAll(loadState());
      alert("Backup importado com sucesso!");
    }catch(err){
      alert("Falha ao importar. Verifique se √© um JSON v√°lido do checklist.");
    }finally{
      e.target.value = "";
    }
  });

  // Atualiza vers√£o na hora
  versionSelectEl.addEventListener("change", ()=>{
    state = loadState();
    state.version = versionSelectEl.value || "acf";
    saveState(state);
    renderAll(loadState());
  });

  // Render inicial
  renderAll(loadState());
</script>
</body>
</html>
