<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plano de Leitura 2026</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      --bg:#070a10;
      --bg2:#0b0f14;
      --card:#0f1726;
      --card2:#0b1220;
      --text:#eaf0f7;
      --muted:#aab6c7;
      --ok:#2ee59d;
      --warn:#ffcc66;
      --accent:#7aa7ff;
      --accent2:#b27aff;
      --danger:#ff6b6b;
      --border: rgba(255,255,255,0.10);
      --shadow: 0 14px 40px rgba(0,0,0,0.45);
      --shadow2: 0 10px 30px rgba(0,0,0,0.32);
      --radius: 18px;
      --radius2: 14px;
    }

    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% -10%, rgba(122,167,255,0.20), transparent 60%),
        radial-gradient(900px 600px at 95% 10%, rgba(178,122,255,0.18), transparent 55%),
        radial-gradient(800px 600px at 60% 110%, rgba(46,229,157,0.10), transparent 55%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 60%, #06070b 100%);
      overflow-x:hidden;
    }

    /* Top bar */
    header{
      max-width:1100px;
      margin:0 auto;
      padding:18px 16px 8px 16px;
    }
    .hero{
      border-radius: 22px;
      padding:16px 16px;
      border:1px solid rgba(255,255,255,0.08);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)),
        radial-gradient(1000px 260px at 10% 0%, rgba(122,167,255,0.25), transparent 60%),
        radial-gradient(800px 240px at 95% 0%, rgba(178,122,255,0.22), transparent 60%);
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .hero:after{
      content:"";
      position:absolute;
      inset:-2px -2px auto auto;
      width:240px;height:240px;
      background: radial-gradient(circle at 25% 25%, rgba(46,229,157,0.20), transparent 60%);
      transform: rotate(15deg);
      pointer-events:none;
    }
    .heroTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    h1{
      margin:0 0 6px 0;
      font-size:22px;
      letter-spacing:0.25px;
      font-weight: 950;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
      max-width: 740px;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      font-size:12px;
      color: var(--text);
      font-weight:900;
      white-space:nowrap;
      backdrop-filter: blur(8px);
    }
    .chip.ok{border-color: rgba(46,229,157,0.28); background: rgba(46,229,157,0.10);}
    .chip.warn{border-color: rgba(255,204,102,0.28); background: rgba(255,204,102,0.10);}
    .chip.danger{border-color: rgba(255,107,107,0.30); background: rgba(255,107,107,0.10);}

    main{max-width:1100px;margin:0 auto;padding:10px 16px 170px 16px;}

    .grid{display:grid;grid-template-columns: 1.2fr 1fr;gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{
      border-radius: var(--radius);
      padding:14px;
      border:1px solid rgba(255,255,255,0.08);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.045), rgba(255,255,255,0.015));
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute;inset:auto -100px -120px auto;
      width:280px;height:280px;
      background: radial-gradient(circle at 30% 30%, rgba(122,167,255,0.18), transparent 60%);
      transform: rotate(-10deg);
      pointer-events:none;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:15px;
      font-weight:950;
      letter-spacing:0.2px;
      display:flex;align-items:center;gap:10px;
    }

    .row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    label.small{font-size:12px;color:var(--muted);font-weight:800}

    select{
      background: rgba(0,0,0,0.25);
      color:var(--text);
      border:1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      padding:12px 12px;
      outline:none;
      min-width: 240px;
      font-weight:850;
      box-shadow: 0 8px 18px rgba(0,0,0,0.25) inset;
    }

    button{
      cursor:pointer;
      background: linear-gradient(180deg, rgba(122,167,255,0.20), rgba(122,167,255,0.08));
      color: var(--text);
      border: 1px solid rgba(122,167,255,0.28);
      padding: 12px 14px;
      border-radius: 16px;
      font-weight:950;
      letter-spacing:0.2px;
      transition: transform .06s ease, filter .15s ease, opacity .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 14px 26px rgba(0,0,0,0.25);
    }
    button:hover{filter:brightness(1.08)}
    button:active{transform: translateY(1px)}
    button.secondary{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: none;
      font-weight:900;
    }
    button.ok{
      background: linear-gradient(180deg, rgba(46,229,157,0.20), rgba(46,229,157,0.08));
      border:1px solid rgba(46,229,157,0.28);
    }
    button.warn{
      background: linear-gradient(180deg, rgba(255,204,102,0.20), rgba(255,204,102,0.08));
      border:1px solid rgba(255,204,102,0.28);
    }
    button.danger{
      background: linear-gradient(180deg, rgba(255,107,107,0.20), rgba(255,107,107,0.08));
      border:1px solid rgba(255,107,107,0.30);
    }
    button:disabled{opacity:0.45;cursor:not-allowed;filter:none;transform:none;box-shadow:none;}

    .stat{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 520px){ .stat{grid-template-columns:1fr;} }
    .kpi{
      padding:14px;border-radius: var(--radius);
      border:1px solid rgba(255,255,255,0.10);
      background:
        linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.16));
      box-shadow: var(--shadow2);
      position:relative;overflow:hidden;
    }
    .kpi:before{
      content:"";
      position:absolute;inset:-60px -70px auto auto;
      width:220px;height:220px;
      background: radial-gradient(circle at 30% 30%, rgba(122,167,255,0.26), transparent 60%);
      transform: rotate(12deg);
      pointer-events:none;
    }
    .kpiHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .kpi .k{font-size:12px;color:var(--muted);font-weight:950;letter-spacing:0.2px}
    .kpi .v{font-size:26px;font-weight:980;margin-top:4px}
    .kpi .sub{margin-top:8px;font-size:12px;color:var(--muted);line-height:1.35}
    .bar{
      height:12px;background: rgba(255,255,255,0.10);
      border-radius:999px;overflow:hidden;margin-top:10px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.25) inset;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(122,167,255,1), rgba(46,229,157,1));
      border-radius:999px;
      transition: width .25s ease;
    }
    .kbd{
      font-size:11px;color:var(--muted);
      border:1px solid rgba(255,255,255,0.14);
      padding:5px 9px;border-radius:999px;
      background: rgba(255,255,255,0.06);
      white-space:nowrap;
      font-weight:950;
    }

    /* Guided */
    .guidedBox{
      margin-top:12px;
      padding:12px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,0.10);
      background:
        radial-gradient(500px 240px at 10% 0%, rgba(46,229,157,0.10), transparent 60%),
        rgba(0,0,0,0.18);
      box-shadow: var(--shadow2);
    }
    .guidedTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .guidedTitle{font-weight:980;font-size:14px;margin:0}
    .guidedMeta{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.35}
    .guidedNow{margin-top:10px;font-size:13px;font-weight:900;line-height:1.55}
    .guidedControls{margin-top:12px;display:grid;grid-template-columns: 1fr 1fr;gap:10px;}
    @media (max-width: 520px){ .guidedControls{grid-template-columns: 1fr;} }
    .guidedControls button{padding:15px 14px;border-radius:16px;font-size:14px}

    .notice{
      margin-top:10px;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,204,102,0.22);
      background: rgba(255,204,102,0.08);
      color: var(--text);
      font-size:12px;
      line-height:1.45;
      display:none;
      box-shadow: 0 12px 25px rgba(0,0,0,0.20);
    }
    .notice.show{display:block;}
    .notice.danger{border-color: rgba(255,107,107,0.30);background: rgba(255,107,107,0.10);}

    /* Months + table */
    details{
      margin-top:14px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.16);
      overflow:hidden;
      box-shadow: var(--shadow2);
    }
    summary{
      list-style:none;
      padding:14px;
      cursor:pointer;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    summary::-webkit-details-marker{display:none}
    .monthTitle{display:flex;align-items:center;gap:10px;font-weight:980}
    .badge{
      font-size:12px;color:var(--muted);
      border:1px solid rgba(255,255,255,0.14);
      padding:5px 9px;border-radius:999px;
      background: rgba(255,255,255,0.06);
      white-space:nowrap;font-weight:950;
    }
    .monthBody{padding:0 12px 12px 12px;}

    .tableWrap{
      border-radius: var(--radius2);
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
    }
    table{width:100%;border-collapse:collapse;}
    thead th{
      position: sticky;
      top:0;
      z-index:2;
      background: rgba(15,23,38,0.95);
      backdrop-filter: blur(10px);
      color: var(--muted);
      font-weight: 980;
      font-size:12px;
      text-transform: uppercase;
      letter-spacing:0.6px;
      border-bottom:1px solid rgba(255,255,255,0.07);
    }
    th, td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,0.07);
      vertical-align:top;
      font-size:13px;
    }
    tbody tr:nth-child(2n){
      background: rgba(255,255,255,0.02);
    }
    tbody tr:hover{
      background: rgba(122,167,255,0.06);
    }
    tr:last-child td{border-bottom:none;}
    .dayCell{white-space:nowrap;color:var(--muted);font-weight:980;}
    .readCell{font-weight:850}
    .note{
      width:100%;
      min-height:40px;
      resize:vertical;
      background: rgba(0,0,0,0.22);
      border:1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      color: var(--text);
      padding:10px;
      outline:none;
      font-weight: 700;
    }
    .note:focus{
      border-color: rgba(122,167,255,0.35);
      box-shadow: 0 0 0 3px rgba(122,167,255,0.12);
    }
    .checkWrap{display:flex;align-items:center;gap:10px}
    input[type="checkbox"]{width:18px;height:18px;accent-color: var(--ok);cursor:pointer}
    .today{
      outline:2px solid rgba(255,204,102,0.32);
      outline-offset:-2px;
      background: rgba(255,204,102,0.07) !important;
    }
    .tiny{font-size:12px;color:var(--muted);line-height:1.35}

    /* Floating "Ir para hoje" */
    .fabToday{
      position:fixed;
      right:16px;
      bottom:92px; /* acima da actionBar no mobile */
      z-index:1001;
      padding:12px 14px;
      border-radius: 999px;
      font-weight: 980;
      letter-spacing:0.2px;
      border:1px solid rgba(255,204,102,0.35);
      background: linear-gradient(180deg, rgba(255,204,102,0.20), rgba(255,204,102,0.08));
      box-shadow: 0 14px 26px rgba(0,0,0,0.25);
      backdrop-filter: blur(10px);
    }
    .fabToday:hover{filter:brightness(1.06)}
    .fabToday:active{transform: translateY(1px)}
    @media (min-width: 981px){
      .fabToday{ bottom:26px; }
    }

    /* Clickable reading cards */
    .readCard{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .06s ease, filter .15s ease, border-color .15s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,0.18);
    }
    .readCard:hover{filter:brightness(1.06); border-color: rgba(122,167,255,0.22);}
    .readCard:active{transform: translateY(1px)}
    .readCard .lbl{
      font-size:11px;
      color:var(--muted);
      font-weight: 980;
      letter-spacing:0.4px;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .readCard .txt{
      font-weight: 900;
      line-height:1.25;
      font-size:13px;
    }
    .readCard .openTag{
      font-size:11px;
      color:var(--text);
      border:1px solid rgba(122,167,255,0.24);
      background: rgba(122,167,255,0.10);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
      font-weight: 950;
    }
    .readCard.disabled{
      opacity:0.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* Monthly calendar (B - moderno e limpo) */
    .monthCal{
      margin: 10px 0 12px 0;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.14);
      overflow:hidden;
      box-shadow: var(--shadow2);
    }
    .monthCalHead{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:0;
      border-bottom:1px solid rgba(255,255,255,0.07);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
    }
    .monthCalHead div{
      padding:10px 8px;
      text-align:center;
      font-size:11px;
      color: var(--muted);
      font-weight: 980;
      letter-spacing:0.6px;
      text-transform: uppercase;
    }
    .monthCalGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      padding:10px;
    }

    .dayBlank{
      border:0;
      margin:0;
      background: transparent;
      min-height: 56px;
      opacity:0.15;
    }

    .dayBtn{
      position: relative;
      min-height: 56px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 980;
      font-size: 15px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition: background .15s ease, transform .08s ease, border-color .15s ease, filter .15s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,0.16);
    }
    .dayBtn:hover{
      background: rgba(122,167,255,0.08);
      border-color: rgba(122,167,255,0.18);
      filter: brightness(1.04);
    }
    .dayBtn:active{ transform: translateY(1px); }

    .dayBtn.today{
      outline:2px solid rgba(255,204,102,0.6);
      outline-offset:-2px;
      box-shadow: 0 0 14px rgba(255,204,102,0.22), 0 10px 22px rgba(0,0,0,0.16);
      background: rgba(255,204,102,0.05);
    }

    .dayBtn .dNum{ line-height:1; }

    .dayBtn .dDot{
      position:absolute;
      bottom:8px;
      right:8px;
      width:9px;
      height:9px;
      border-radius:999px;
      background: rgba(255,255,255,0.22); /* pendente */
      border:1px solid rgba(255,255,255,0.10);
    }
    .dayBtn.done .dDot{
      background: rgba(46,229,157,0.95);
      border-color: rgba(46,229,157,0.25);
      box-shadow: 0 0 10px rgba(46,229,157,0.18);
    }
    .dayBtn.late .dDot{
      background: rgba(255,107,107,0.95);
      border-color: rgba(255,107,107,0.25);
      box-shadow: 0 0 10px rgba(255,107,107,0.18);
    }



    /* Plano do dia (abaixo do calend√°rio) - sem tabela para n√£o parecer "2 calend√°rios" */
    .dayPlan{
      margin: 12px 0 0 0;
      padding: 12px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.16);
      box-shadow: var(--shadow2);
    }
    .dayPlanHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .dayPlanHead .title{
      font-weight: 980;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .dayPlanGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){
      .dayPlanGrid{ grid-template-columns: 1fr; }
    }
    .dayBlock{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.14);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 126px;
    }
    .dayBlock .h{
      font-size:11px;
      color: var(--muted);
      font-weight: 980;
      letter-spacing:0.6px;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .dayBlock .t{
      font-weight: 980;
      line-height:1.25;
      font-size: 14px;
      flex:1;
    }
    .btnOpen{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(122,167,255,0.22);
      background: rgba(122,167,255,0.10);
      color: var(--text);
      font-weight: 980;
      cursor:pointer;
      width:100%;
    }
    .btnOpen:hover{ filter:brightness(1.06); }
    .btnOpen:active{ transform: translateY(1px); }

    .dayMeta{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 220px 1fr;
      gap:10px;
      align-items:start;
    }
    @media (max-width: 980px){
      .dayMeta{ grid-template-columns: 1fr; }
    }
    .dayMeta textarea.note{ min-height: 86px; }

    /* Esconde a tabela mensal antiga (para n√£o parecer 2 calend√°rios) */
    .tableWrap{ display:none !important; }


    /* row pulse highlight when jumping */
    @keyframes pulseRing{
      0%{ box-shadow: 0 0 0 0 rgba(255,204,102,0.0); }
      25%{ box-shadow: 0 0 0 6px rgba(255,204,102,0.14); }
      55%{ box-shadow: 0 0 0 12px rgba(255,204,102,0.10); }
      100%{ box-shadow: 0 0 0 0 rgba(255,204,102,0.0); }
    }
    tr.pulse{ animation: pulseRing 900ms ease-out; }

    /* Leitor b√≠blico interno (texto via API) */
    .readerModal{position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:12px;backdrop-filter: blur(6px);}
    .readerModal.open{display:flex;}
    .readerSheet{width:min(900px,100%);height:90vh;background:rgba(10,12,16,.96);border-radius:18px;border:1px solid rgba(255,255,255,.12);display:flex;flex-direction:column;box-shadow:0 30px 70px rgba(0,0,0,.5);overflow:hidden;}
    .readerTop{padding:12px 14px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,.1);}
    .readerRef{margin:10px 0 12px 0;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:rgba(220,235,255,.95);font-size:13px;line-height:1.4;}
    .readerTitle{font-weight:980;}
    .readerActions{display:flex;gap:8px;}
    .readerBtn{border-radius:12px;padding:8px 12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);color:#fff;cursor:pointer;font-weight:980;}
    .readerBtn:hover{filter:brightness(1.06);border-color: rgba(122,167,255,.22);background: rgba(122,167,255,.10);}
    .readerBtn:disabled{opacity:.45;cursor:not-allowed;filter:none;}

    .readerBtn.danger:hover{border-color: rgba(255,107,107,.28);background: rgba(255,107,107,.12);}
    .readerBody{padding:14px;overflow-y:auto;line-height:1.7;font-size:16px;}
    .readerLoading{color:#aaa;font-style:italic;}
    .readerError{margin:10px 0 12px 0;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,107,107,.25);background:rgba(255,107,107,.10);color: rgba(255,220,220,.95);font-size:13px;line-height:1.5;white-space:pre-wrap;}
    .readerText p{margin-bottom:10px;}
    
    .readerRef{margin:10px 0 12px 0;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:rgba(220,235,255,.95);font-size:13px;line-height:1.4;}
    .readerTools{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 12px 0;}
    .readerSearch{flex:1;min-width:220px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);color:rgba(240,248,255,.98);outline:none;font-weight:700;}
    .readerSearch::placeholder{color:rgba(200,210,225,.55);font-weight:700;}
    .readerSearch:focus{border-color:rgba(122,167,255,.32);background:rgba(122,167,255,.08);}
    .verse{padding:8px 10px;border-radius:14px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);cursor:pointer;transition:transform .05s ease, filter .12s ease, background .12s ease, border-color .12s ease;}
    .verse:hover{filter:brightness(1.06);border-color:rgba(122,167,255,.20);}
    .verse:active{transform:translateY(1px);}
    .verse b{display:inline-block;min-width:22px;text-align:right;margin-right:8px;}
    .verse.hl{border-color:rgba(255,215,102,0.35);background:rgba(255,215,102,0.12);box-shadow:0 10px 18px rgba(0,0,0,0.18);}
    .verse.active{border-color:rgba(122,167,255,.35);background:rgba(122,167,255,.10);}
    mark.readerMark{padding:0 4px;border-radius:8px;background:rgba(122,167,255,.22);color:rgba(255,255,255,.98);}

    @media(max-width:980px){.readerSheet{height:95vh;}.readerBody{font-size:17px;}}

    /* Di√°rio do dia (Resumo + Vers√≠culo do dia) */
    .diaryModal{position:fixed;inset:0;z-index:3200;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:12px;backdrop-filter: blur(6px);}
    .diaryModal.open{display:flex;}
    .diarySheet{width:min(900px,100%);height:88vh;background:rgba(10,12,16,.96);border-radius:18px;border:1px solid rgba(255,255,255,.12);display:flex;flex-direction:column;box-shadow:0 30px 70px rgba(0,0,0,.5);overflow:hidden;}
    .diaryTop{padding:12px 14px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,.1);}
    .diaryTitle{font-weight:980;}
    .diaryActions{display:flex;gap:8px;}
    .diaryBody{padding:14px;overflow-y:auto;line-height:1.6;}
    .diaryRef{margin: 2px 0 10px 0;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:rgba(220,235,255,.95);font-size:13px;}
    .diaryLabel{display:block;margin:8px 0 6px 0;color:rgba(235,245,255,.9);font-weight:900;}
    .diarySummary{width:100%;resize:vertical;min-height:90px;padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);color:rgba(240,248,255,.98);outline:none;font-weight:700;}
    .diarySummary:focus{border-color:rgba(122,167,255,.32);background:rgba(122,167,255,.08);}
    .diaryDivider{height:1px;background:rgba(255,255,255,.10);margin:14px 0;}
    .diaryRow{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px;}
    .diaryRowTitle{font-weight:980;}
    .diaryHint{color:rgba(200,210,225,.70);font-size:13px;margin-bottom:10px;}
    .diaryVerses{display:flex;flex-direction:column;gap:10px;}
    .diaryVerse{padding:12px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);cursor:pointer;}
    .diaryVerse:hover{filter:brightness(1.06);border-color:rgba(122,167,255,.20);}
    .diaryVerse.selected{border-color:rgba(255,215,102,0.40);background:rgba(255,215,102,0.10);}
    .diaryVerseTop{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;}
    .diaryVerseRef{font-weight:980;}
    .diaryVerseText{color:rgba(240,248,255,.92);margin-top:6px;white-space:pre-wrap;}
    @media(max-width:980px){.diarySheet{height:95vh;}}



    /* Mobile bottom bar */
    .actionBar{
      position:fixed;left:0; right:0; bottom:0;
      padding:10px 12px 14px 12px;
      background: rgba(7,10,16,0.90);
      border-top: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(12px);
      z-index:999;
    }
    .actionBar .wrap{
      max-width:1100px;margin:0 auto;
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .actionBar .btnBig{
      flex:1;min-width: 190px;
      padding:15px 14px;border-radius:16px;font-size:14px;
    }
    .actionBar .hint{
      width:100%;
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      opacity:0.95;
    }
    @media (min-width: 981px){
      main{padding-bottom:140px;}
      .actionBar{padding:8px 12px 10px 12px;}
      .actionBar .btnBig{max-width: 380px;flex:0 1 auto;padding:12px 14px;}
    }
  </style>
</head>
<body>

  <!-- Leitor b√≠blico interno (texto via API) -->
  <div class="readerModal" id="readerModal" aria-hidden="true">
    <div class="readerSheet" role="dialog" aria-modal="true" aria-label="Leitura b√≠blica">
      <div class="readerTop">
        <div class="readerTitle">üìñ Leitura b√≠blica</div>
        <div class="readerActions">
          <button class="readerBtn" id="readerPlanPrevBtn" type="button" title="Voltar no plano">‚óÄ Plano</button>
          <button class="readerBtn" id="readerPlanNextBtn" type="button" title="Avan√ßar no plano">Plano ‚ñ∂</button>
          <button class="readerBtn" id="readerExternalBtn" type="button">Abrir externo</button>
          <button class="readerBtn danger" id="readerCloseBtn" type="button">Fechar ‚úï</button>
        </div>
      </div>

  <!-- Di√°rio do dia (Resumo + Vers√≠culo do dia) -->
  <div class="diaryModal" id="diaryModal" aria-hidden="true">
    <div class="diarySheet" role="dialog" aria-modal="true" aria-label="Di√°rio do dia">
      <div class="diaryTop">
        <div class="diaryTitle">üìå Di√°rio do dia</div>
        <div class="diaryActions">
          <button class="readerBtn" id="diarySaveBtn" type="button">Salvar</button>
          <button class="readerBtn danger" id="diaryCloseBtn" type="button">Fechar ‚úï</button>
        </div>
      </div>
      <div class="diaryBody">
        <div class="diaryRef" id="diaryRef">Dia ‚Äî</div>
        <label class="diaryLabel" for="diarySummary">Resumo r√°pido (2‚Äì3 linhas)</label>
        <textarea id="diarySummary" class="diarySummary" rows="3" placeholder="Ex.: O que Deus falou comigo hoje? O que aprendi? Como aplicar?"></textarea>

        <div class="diaryDivider"></div>

        <div class="diaryRow">
          <div class="diaryRowTitle">üîñ Vers√≠culo do dia (a partir dos seus destaques)</div>
          <button class="readerBtn" id="diaryRefreshBtn" type="button" title="Atualizar lista de destaques">Atualizar</button>
        </div>
        <div class="diaryHint" id="diaryHint">Dica: destaque vers√≠culos no leitor (clicando no verso) e depois selecione aqui.</div>

        <div class="diaryVerses" id="diaryVerses"></div>
      </div>
    </div>
  </div>
      <div class="readerBody">
        <div class="readerTools">
          <input id="readerSearch" class="readerSearch" type="search" placeholder="Buscar no cap√≠tulo (ex.: f√©, Deus, amor)..." autocomplete="off" />
          <button class="readerBtn" id="readerClearSearchBtn" type="button" title="Limpar busca">Limpar</button>
          <button class="readerBtn" id="readerClearHighlightsBtn" type="button" title="Remover destaques deste cap√≠tulo">Limpar destaques</button>
        </div>
        <div class="readerRef" id="readerRef"></div>
        <div class="readerLoading" id="readerLoading">Carregando texto b√≠blico‚Ä¶</div>
        <div class="readerError" id="readerError" style="display:none"></div>
        <div class="readerText" id="readerText"></div>
      </div>
    </div>
  </div>


<header>
  <div class="hero">
    <div class="heroTop">
      <div>
        <h1>Plano de Leitura 2026</h1>
        <p class="subtitle">
          Plano fixo inicia em <b>01/01/2026</b>. Se voc√™ come√ßou depois, o site mostra seu <b>atraso</b> e ajuda a recuperar.
        </p>
      </div>
      <div class="chips">
        <span class="chip ok">‚úÖ Salva autom√°tico</span>
        <span class="chip warn">üìÖ 2026</span>
        <span class="chip" id="chipPlan">üìñ Plano: ‚Äî</span>
        <span class="chip danger" id="chipLate" style="display:none;">‚ö†Ô∏è Atraso: ‚Äî</span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>‚öôÔ∏è Configura√ß√£o</h2>

      <div class="row">
        <div>
          <label class="small">Tradu√ß√£o (B√≠blia Online)</label><br/>
          <select id="versionSelect">
            <option value="acf">ACF</option>
            <option value="ara">ARA</option>
            <option value="arc">ARC</option>
            <option value="naa">NAA</option>
            <option value="nvi">NVI</option>
          </select>
        </div>

        <div>
          <label class="small">Tipo de plano</label><br/>
          <select id="planMode">
            <option value="parallel">Paralelo (AT + NT em ordem)</option>
            <option value="gospel_history_psalms">Evangelho + Hist√≥ria do AT + Salmos/Prov√©rbios</option>
            <option value="wisdom_letters_ot">Sabedoria + Cartas + AT</option>
          </select>
        </div>

        <div style="flex:1"></div>

        <button class="secondary" id="openTodayBtn">Abrir m√™s de hoje</button>
        <button id="applyBtn">Aplicar</button>
      </div>

      <div class="stat">
        <div class="kpi">
          <div class="kpiHead">
            <div class="k">Progresso do ano</div>
            <div class="kbd" id="yearPct">0%</div>
          </div>
          <div class="v" id="yearProgressText">0/365</div>
          <div class="bar"><div id="yearBar"></div></div>
          <div class="sub" id="yearSub">Comece hoje ‚Äî um dia de cada vez.</div>
        </div>

        <div class="kpi">
          <div class="kpiHead">
            <div class="k">Dias consecutivos</div>
            <div class="kbd">üî• streak</div>
          </div>
          <div class="v" id="streakText">0</div>
          <div class="sub" id="streakSub">Marque a leitura de hoje para iniciar a sequ√™ncia.</div>
        </div>
      </div>

      <div class="guidedBox">
        <div class="guidedTop">
          <div>
            <p class="guidedTitle">üìñ Leitura guiada (1 aba)</p>
            <div class="guidedMeta">
              ‚ÄúIniciar‚Äù abre 1 aba. ‚ÄúColocar em dia‚Äù abre um pacote maior para recuperar atraso.
            </div>
          </div>
          <div class="kbd" id="guidedStep">Cap√≠tulo 0/0</div>
        </div>

        <div class="guidedNow" id="guidedNow">Hoje: ‚Äî</div>

        <div class="notice danger" id="lateNotice"></div>
        <div class="notice" id="guidedNotice"></div>

        <div class="guidedControls">
          <button class="warn" id="guidedStartBtn">üìñ Iniciar (1 aba)</button>
          <button class="danger" id="catchUpBtn">‚è© Colocar em dia (atraso)</button>
          <button class="secondary" id="guidedPrevBtn">‚¨ÖÔ∏è Cap√≠tulo anterior</button>
          <button class="secondary" id="guidedNextBtn">Pr√≥ximo cap√≠tulo ‚û°Ô∏è</button>
          <button class="ok" id="guidedFinishBtn">‚úÖ Finalizei a leitura de hoje</button>
        </div>

        <div class="tiny" style="margin-top:10px">
          Dica: se o navegador bloquear pop-up, clique em ‚ÄúIniciar‚Äù primeiro.
        </div>
      </div>
    </section>

    <section class="card">
      <h2>‚ú® Dicas r√°pidas</h2>
      
      <div class="tiny" style="line-height:1.85">
        <div style="display:grid; gap:10px">
          <div><b>üìÖ Ir para hoje:</b> use o bot√£o flutuante <span class="kbd">‚ÄúIr para hoje‚Äù</span> para pular direto para a leitura do dia.</div>
          <div><b>üß© Cards clic√°veis:</b> toque em cada card de leitura do dia (AT/NT/etc.) para abrir o <b>cap√≠tulo</b> direto na B√≠blia Online.</div>
          <div><b>üóìÔ∏è Vis√£o mensal:</b> cada m√™s agora tem um <b>calend√°rio</b>. Toque no dia para ir para a linha dele e marcar como feito.</div>
          <div><b>‚è© Atraso:</b> se estiver atrasado, o topo mostra quantos dias faltam e o bot√£o <span class="kbd">‚ÄúColocar em dia‚Äù</span> abre o pacote acumulado.</div>
        </div>
      </div>
    </div>
    </section>
  </div>

  <div id="months"></div>
</main>

<button class="fabToday" id="fabToday" title="Ir para a leitura de hoje">üìÖ Ir para hoje</button>

<div class="actionBar">
  <div class="wrap">
    <button class="btnBig warn" id="startTodayReadingBtn">üìñ Iniciar leitura de hoje</button>
    <button class="btnBig ok" id="finishTodayBtn">‚úÖ Finalizei a leitura de hoje</button>
    <div class="hint" id="todayHint">Hoje: ‚Äî</div>
  </div>
</div>

<script>
  const YEAR = 2026;
  const PLAN_START = "2026-01-01"; // FIXO
  const DEFAULT_VERSION = "acf";
  const DEFAULT_MODE = "gospel_history_psalms";
  const OT_CHAPTERS_PATTERN = [3,3,2,3,3,2,2];

  const OT_ALL = [
    ["G√™nesis",50],["√äxodo",40],["Lev√≠tico",27],["N√∫meros",36],["Deuteron√¥mio",34],
    ["Josu√©",24],["Ju√≠zes",21],["Rute",4],["1 Samuel",31],["2 Samuel",24],
    ["1 Reis",22],["2 Reis",25],["1 Cr√¥nicas",29],["2 Cr√¥nicas",36],["Esdras",10],
    ["Neemias",13],["Ester",10],["J√≥",42],["Salmos",150],["Prov√©rbios",31],
    ["Eclesiastes",12],["Cantares",8],["Isa√≠as",66],["Jeremias",52],["Lamenta√ß√µes",5],
    ["Ezequiel",48],["Daniel",12],["Os√©ias",14],["Joel",3],["Am√≥s",9],
    ["Obadias",1],["Jonas",4],["Miqu√©ias",7],["Naum",3],["Habacuque",3],
    ["Sofonias",3],["Ageu",2],["Zacarias",14],["Malaquias",4]
  ];

  const OT_HISTORY = [
    ["G√™nesis",50],["√äxodo",40],["Lev√≠tico",27],["N√∫meros",36],["Deuteron√¥mio",34],
    ["Josu√©",24],["Ju√≠zes",21],["Rute",4],["1 Samuel",31],["2 Samuel",24],
    ["1 Reis",22],["2 Reis",25],["1 Cr√¥nicas",29],["2 Cr√¥nicas",36],["Esdras",10],
    ["Neemias",13],["Ester",10]
  ];

  const PSALMS = [["Salmos",150]];
  const PROVERBS = [["Prov√©rbios",31]];
  const WISDOM = [["Prov√©rbios",31],["Eclesiastes",12]];

  const NT_ALL = [
    ["Mateus",28],["Marcos",16],["Lucas",24],["Jo√£o",21],["Atos",28],
    ["Romanos",16],["1 Cor√≠ntios",16],["2 Cor√≠ntios",13],["G√°latas",6],["Ef√©sios",6],
    ["Filipenses",4],["Colossenses",4],["1 Tessalonicenses",5],["2 Tessalonicenses",3],
    ["1 Tim√≥teo",6],["2 Tim√≥teo",4],["Tito",3],["Filemom",1],["Hebreus",13],
    ["Tiago",5],["1 Pedro",5],["2 Pedro",3],["1 Jo√£o",5],["2 Jo√£o",1],
    ["3 Jo√£o",1],["Judas",1],["Apocalipse",22]
  ];

  const GOSPEL_ACTS = [["Mateus",28],["Marcos",16],["Lucas",24],["Jo√£o",21],["Atos",28]];
  const LETTERS = [
    ["Romanos",16],["1 Cor√≠ntios",16],["2 Cor√≠ntios",13],["G√°latas",6],["Ef√©sios",6],
    ["Filipenses",4],["Colossenses",4],["1 Tessalonicenses",5],["2 Tessalonicenses",3],
    ["1 Tim√≥teo",6],["2 Tim√≥teo",4],["Tito",3],["Filemom",1],["Hebreus",13],
    ["Tiago",5],["1 Pedro",5],["2 Pedro",3],["1 Jo√£o",5],["2 Jo√£o",1],
    ["3 Jo√£o",1],["Judas",1]
  ];

  const BO_BOOK_CODE = {
    "G√™nesis":"gn","√äxodo":"ex","Lev√≠tico":"lv","N√∫meros":"nm","Deuteron√¥mio":"dt",
    "Josu√©":"js","Ju√≠zes":"jz","Rute":"rt","1 Samuel":"1sm","2 Samuel":"2sm",
    "1 Reis":"1rs","2 Reis":"2rs","1 Cr√¥nicas":"1cr","2 Cr√¥nicas":"2cr","Esdras":"ed",
    "Neemias":"ne","Ester":"et","J√≥":"jo","Salmos":"sl","Prov√©rbios":"pv",
    "Eclesiastes":"ec","Cantares":"ct","Isa√≠as":"is","Jeremias":"jr","Lamenta√ß√µes":"lm",
    "Ezequiel":"ez","Daniel":"dn","Os√©ias":"os","Joel":"jl","Am√≥s":"am",
    "Obadias":"ob","Jonas":"jn","Miqu√©ias":"mq","Naum":"na","Habacuque":"hc",
    "Sofonias":"sf","Ageu":"ag","Zacarias":"zc","Malaquias":"ml",
    "Mateus":"mt","Marcos":"mc","Lucas":"lc","Jo√£o":"jo","Atos":"at",
    "Romanos":"rm","1 Cor√≠ntios":"1co","2 Cor√≠ntios":"2co","G√°latas":"gl","Ef√©sios":"ef",
    "Filipenses":"fp","Colossenses":"cl","1 Tessalonicenses":"1ts","2 Tessalonicenses":"2ts",
    "1 Tim√≥teo":"1tm","2 Tim√≥teo":"2tm","Tito":"tt","Filemom":"fm","Hebreus":"hb",
    "Tiago":"tg","1 Pedro":"1pe","2 Pedro":"2pe","1 Jo√£o":"1jo","2 Jo√£o":"2jo",
    "3 Jo√£o":"3jo","Judas":"jd","Apocalipse":"ap"
  };

  function bibleOnlineUrl(version, bookName, chapterNumber){
    const code = BO_BOOK_CODE[bookName];
    if (!code) return null;
    return `https://www.bibliaonline.com.br/${version}/${code}/${chapterNumber}`;
  }

  const pad2 = (n)=> String(n).padStart(2,"0");
  function ymd(date){ return `${date.getFullYear()}-${pad2(date.getMonth()+1)}-${pad2(date.getDate())}`; }
  function parseYMD(s){ const [Y,M,D]=s.split("-").map(Number); return new Date(Y, M-1, D); }
  function daysBetween(a,b){
    const ms = 24*60*60*1000;
    const aa = new Date(a.getFullYear(),a.getMonth(),a.getDate()).getTime();
    const bb = new Date(b.getFullYear(),b.getMonth(),b.getDate()).getTime();
    return Math.floor((bb-aa)/ms);
  }
  function totalChapters(list){ return list.reduce((acc,[,c])=>acc+c,0); }
  function chapterAt(globalIndex, list){
    let idx = globalIndex;
    for (const [book, count] of list){
      if (idx < count) return { book, chapter: idx+1 };
      idx -= count;
    }
    const total = totalChapters(list);
    idx = ((globalIndex % total)+total)%total;
    return chapterAt(idx, list);
  }
  function nextNChaptersList(startIndex, n, list){
    const chapters = [];
    for (let i = 0; i < n; i++) chapters.push(chapterAt(startIndex + i, list));
    return chapters;
  }
  function rangeTextForList(list){
    const out = [];
    let i = 0;
    while (i < list.length){
      const b = list[i].book;
      let start = list[i].chapter;
      let end = start;
      let j = i+1;
      while (j < list.length && list[j].book === b && list[j].chapter === end + 1){
        end = list[j].chapter; j++;
      }
      out.push(end === start ? `${b} ${start}` : `${b} ${start}‚Äì${end}`);
      i = j;
    }
    return out.join("; ");
  }

  const KEY = "planoLeitura2026_v7_pretty";
  const READING_WINDOW_NAME = "bibliaOnlineReading";

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      return raw ? JSON.parse(raw) : { version: DEFAULT_VERSION, planMode: DEFAULT_MODE, days:{}, guided:{} };
    }catch{
      return { version: DEFAULT_VERSION, planMode: DEFAULT_MODE, days:{}, guided:{} };
    }
  }
  function saveState(state){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function ensureStateDefaults(state){
    if (!state.version) state.version = DEFAULT_VERSION;
    if (!state.planMode) state.planMode = DEFAULT_MODE;
    if (!state.days) state.days = {};
    if (!state.guided) state.guided = {};
    return state;
  }

  function getPlanStreams(planMode){
    if (planMode === "parallel"){
      return [
        { key:"s1", label:"AT", listBooks: OT_ALL, perDayFn:(off)=> OT_CHAPTERS_PATTERN[off % 7], cycle:false },
        { key:"s2", label:"NT", listBooks: NT_ALL, perDayFn:()=> 1, cycle:true }
      ];
    }
    if (planMode === "wisdom_letters_ot"){
      return [
        { key:"s1", label:"AT", listBooks: OT_ALL, perDayFn:()=> 2, cycle:false },
        { key:"s2", label:"Sabedoria", listBooks: WISDOM, perDayFn:()=> 1, cycle:true },
        { key:"s3", label:"Cartas", listBooks: LETTERS, perDayFn:()=> 1, cycle:true }
      ];
    }
    return [
      { key:"s1", label:"Hist√≥ria (AT)", listBooks: OT_HISTORY, perDayFn:()=> 2, cycle:false },
      { key:"s2", label:"Evangelho/Atos", listBooks: GOSPEL_ACTS, perDayFn:()=> 1, cycle:true },
      { key:"s3", label:"Salmos/Prov√©rbios", listBooks: null, perDayFn:()=> 1, cycle:true, special:"ps_prov_alt" }
    ];
  }

  function modeLabel(mode){
    if (mode === "parallel") return "Paralelo";
    if (mode === "wisdom_letters_ot") return "Sabedoria + Cartas";
    return "Evangelho + Hist√≥ria + Salmos";
  }

  function buildPlanForYear(state){
    const startDate = parseYMD(PLAN_START);
    const streams = getPlanStreams(state.planMode);

    const pos = {};
    for (const s of streams) pos[s.key] = 0;
    let psPos = 0, pvPos = 0;

    const plan = {};
    const yearStart = new Date(YEAR,0,1);
    const yearEnd = new Date(YEAR,11,31);

    for (let d = new Date(yearStart); d <= yearEnd; d.setDate(d.getDate()+1)){
      const key = ymd(d);
      if (d < startDate){
        plan[key] = { active:false, blocks:[], guidedList:[] };
        continue;
      }
      const offset = daysBetween(startDate, d);
      const blocks = [];
      let guidedList = [];

      for (const s of streams){
        const n = s.perDayFn(offset);
        let list = [];

        if (s.special === "ps_prov_alt"){
          if (offset % 2 === 0){
            list = nextNChaptersList(psPos, n, PSALMS);
            psPos = (psPos + n) % totalChapters(PSALMS);
          } else {
            list = nextNChaptersList(pvPos, n, PROVERBS);
            pvPos = (pvPos + n) % totalChapters(PROVERBS);
          }
        } else {
          list = nextNChaptersList(pos[s.key], n, s.listBooks);
          pos[s.key] += n;
          const total = totalChapters(s.listBooks);
          if (pos[s.key] >= total){
            if (!s.cycle) pos[s.key] = total;
            else pos[s.key] = pos[s.key] % total;
          }
        }

        blocks.push({ label: s.label, text: list.length ? rangeTextForList(list) : "‚Äî", list });
        guidedList = guidedList.concat(list);
      }

      plan[key] = { active:true, blocks, guidedList };
    }
    return plan;
  }

  function calcStreak(state, today){
    let streak = 0;
    let d = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    while (true){
      if (d.getFullYear() !== YEAR) break;
      const key = ymd(d);
      if (state.days?.[key]?.done){ streak++; d.setDate(d.getDate()-1); }
      else break;
    }
    return streak;
  }

  function getGuidedIndex(state, dateKey){
    const idx = state.guided?.[dateKey]?.idx;
    return Number.isFinite(idx) ? idx : 0;
  }
  function setGuidedIndex(state, dateKey, idx){
    state.guided = state.guided || {};
    state.guided[dateKey] = state.guided[dateKey] || {};
    state.guided[dateKey].idx = idx;
  }
  function openInSingleReadingTab(url){
    window.open(url, READING_WINDOW_NAME, "noopener,noreferrer");
  }

  function openDayGuided(dateKey, targetIndex){
    const state = ensureStateDefaults(loadState());
    const plan = buildPlanForYear(state);
    const p = plan[dateKey];
    if (!p?.active) return alert("Este dia est√° fora do per√≠odo do plano.");
    const list = p.guidedList || [];
    if (!list.length) return alert("N√£o h√° leitura para este dia.");
    const total = list.length;
    const idx = Math.max(0, Math.min(targetIndex, total-1));
    const item = list[idx];
    setGuidedIndex(state, dateKey, idx);
    saveState(state);
    openBibleReader(item.book, item.chapter, { dateKey: dateKey, idx: idx, list: list });
    renderAll();
}

  function goToToday(){
    const t = new Date();
    if (t.getFullYear() !== YEAR){ return alert(`Checklist √© de ${YEAR}.`); }
    const key = ymd(t);

    const st = ensureStateDefaults(loadState());
    st.ui = st.ui || {};
    st.ui.selectedDay = key;
    saveState(st);
    renderAll();

    const el = document.getElementById(`m-${YEAR}-${pad2(t.getMonth()+1)}`);
    if (el){ el.open = true; el.scrollIntoView({behavior:"smooth", block:"start"}); }

    setTimeout(()=>{
      const panel = document.querySelector(`.dayPlan[data-datekey="${key}"]`);
      if (panel) panel.scrollIntoView({behavior:"smooth", block:"start"});
    }, 140);
  }

  function getLateDays(state){
    const today = new Date();
    if (today.getFullYear() !== YEAR) return 0;

    const planStart = parseYMD(PLAN_START);
    const todayKey = ymd(today);
    let late = 0;

    for (let d = new Date(planStart); d <= today; d.setDate(d.getDate()+1)){
      const k = ymd(d);
      if (k === todayKey) break;
      if (!state.days?.[k]?.done) late++;
    }
    return late;
  }

  function openGuidedAtIndex(targetIndex){
    const state = ensureStateDefaults(loadState());
    const plan = buildPlanForYear(state);
    const today = new Date();

    if (today.getFullYear() !== YEAR) return alert(`Checklist √© de ${YEAR}.`);
    const key = ymd(today);
    const p = plan[key];
    if (!p?.active) return alert("Hoje est√° fora do per√≠odo do plano.");

    const pack = state.guided?.[key]?.catchUpPack;
    const list = (Array.isArray(pack) && pack.length) ? pack : (p.guidedList || []);
    if (!list.length) return alert("N√£o h√° leitura para hoje.");

    const total = list.length;
    const idx = Math.max(0, Math.min(targetIndex, total-1));
    const item = list[idx];

    setGuidedIndex(state, key, idx);
    saveState(state);
    // abre no leitor interno
    openBibleReader(item.book, item.chapter, { dateKey: key, idx: idx, list: list });
    renderAll();
}

  function openCatchUpPack(){
    const state = ensureStateDefaults(loadState());
    const plan = buildPlanForYear(state);
    const today = new Date();

    if (today.getFullYear() !== YEAR) return alert(`Checklist √© de ${YEAR}.`);

    const late = getLateDays(state);
    if (late <= 0){
      alert("Voc√™ est√° em dia! ‚úÖ");
      return;
    }

    const start = parseYMD(PLAN_START);

    let firstMissing = null;
    for (let d = new Date(start); d <= today; d.setDate(d.getDate()+1)){
      const k = ymd(d);
      if (!state.days?.[k]?.done){
        firstMissing = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        break;
      }
    }
    if (!firstMissing) return alert("Voc√™ est√° em dia! ‚úÖ");

    const pack = [];
    for (let d = new Date(firstMissing); d <= today; d.setDate(d.getDate()+1)){
      const k = ymd(d);
      const p = plan[k];
      if (p?.active) pack.push(...(p.guidedList || []));
    }
    if (!pack.length) return alert("N√£o consegui montar o pacote de recupera√ß√£o.");

    state.guided = state.guided || {};
    const todayKey = ymd(today);
    state.guided[todayKey] = state.guided[todayKey] || {};
    state.guided[todayKey].catchUpPack = pack;
    state.guided[todayKey].idx = 0;
    saveState(state);

    const first = pack[0];

    // abre no leitor interno
    openBibleReader(first.book, first.chapter, { dateKey: null, idx: 0, list: pack });
    renderAll();
}

  function finishTodayReading(){
    const state = ensureStateDefaults(loadState());
    const now = new Date();
    if (now.getFullYear() !== YEAR) return alert(`Checklist √© de ${YEAR}.`);

    const key = ymd(now);
    state.days[key] = state.days[key] || {};
    state.days[key].done = true;

    const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1);
    if (tomorrow.getFullYear() === YEAR){
      const tKey = ymd(tomorrow);
      state.guided[tKey] = state.guided[tKey] || {};
      state.guided[tKey].idx = 0;
      // n√£o propaga pack
    }
    saveState(state);

    const el = document.getElementById(`m-${YEAR}-${pad2(now.getMonth()+1)}`);
    if (el){ el.open = true; el.scrollIntoView({behavior:"smooth", block:"start"}); }
    renderAll();
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function cssEscape(id){
    return id.replaceAll(":", "\\:").replaceAll(".", "\\.").replaceAll("/", "\\/");
  }

  function updateTodayHint(plan, state, today){
    const hint = document.getElementById("todayHint");
    if (today.getFullYear() !== YEAR){ hint.textContent = `Checklist √© de ${YEAR}.`; return; }
    const key = ymd(today);
    const p = plan[key];
    if (!p?.active){ hint.textContent = "Hoje est√° fora do per√≠odo do plano."; return; }
    const done = !!state.days?.[key]?.done;
    const text = (p.blocks || []).map(b => `${b.label}: ${b.text}`).join(" ‚Ä¢ ");
    hint.textContent = `Hoje: ${text}${done ? " ‚úÖ" : ""}`;
  }

  function updateLateUI(state){
    const lateEl = document.getElementById("lateNotice");
    const catchUpBtn = document.getElementById("catchUpBtn");
    const chipLate = document.getElementById("chipLate");
    const today = new Date();

    if (today.getFullYear() !== YEAR){
      lateEl.classList.remove("show");
      catchUpBtn.disabled = true;
      chipLate.style.display = "none";
      return;
    }

    const late = getLateDays(state);
    if (late > 0){
      lateEl.textContent = `‚ö†Ô∏è Voc√™ est√° ${late} dia(s) atrasado. Use ‚ÄúColocar em dia‚Äù para abrir a leitura acumulada.`;
      lateEl.classList.add("show");
      catchUpBtn.disabled = false;

      chipLate.style.display = "inline-flex";
      chipLate.textContent = `‚ö†Ô∏è Atraso: ${late} dia(s)`;
    } else {
      lateEl.classList.remove("show");
      catchUpBtn.disabled = true;
      chipLate.style.display = "none";
    }
  }

  function updateGuidedUI(plan, state, today){
    const nowEl = document.getElementById("guidedNow");
    const stepEl = document.getElementById("guidedStep");
    const noticeEl = document.getElementById("guidedNotice");

    const startBtn = document.getElementById("guidedStartBtn");
    const prevBtn  = document.getElementById("guidedPrevBtn");
    const nextBtn  = document.getElementById("guidedNextBtn");
    const finishBtn= document.getElementById("guidedFinishBtn");

    if (today.getFullYear() !== YEAR){
      nowEl.textContent = "Hoje: ‚Äî";
      stepEl.textContent = "Cap√≠tulo 0/0";
      noticeEl.classList.remove("show");
      startBtn.disabled = true; prevBtn.disabled = true; nextBtn.disabled = true; finishBtn.disabled = true;
      return;
    }

    const key = ymd(today);
    const p = plan[key];
    if (!p?.active){
      nowEl.textContent = "Hoje: ‚Äî";
      stepEl.textContent = "Cap√≠tulo 0/0";
      noticeEl.classList.remove("show");
      startBtn.disabled = true; prevBtn.disabled = true; nextBtn.disabled = true; finishBtn.disabled = true;
      return;
    }

    startBtn.disabled = false;
    finishBtn.disabled = false;

    const pack = state.guided?.[key]?.catchUpPack;
    const list = (Array.isArray(pack) && pack.length) ? pack : (p.guidedList || []);

    const idx = Math.max(0, Math.min(getGuidedIndex(state, key), Math.max(0, list.length-1)));
    const total = list.length;

    const blocksText = (p.blocks || []).map(b => `<span style="color:var(--muted);font-weight:950">${escapeHtml(b.label)}:</span> <b>${escapeHtml(b.text)}</b>`).join("<br/>");
    const done = !!state.days?.[key]?.done;

    if (!total){
      nowEl.innerHTML = `Hoje:<br/>${blocksText}${done ? " ‚úÖ" : ""}<br/><br/><b>Sem cap√≠tulos para navega√ß√£o.</b>`;
      stepEl.textContent = "Cap√≠tulo 0/0";
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      noticeEl.classList.remove("show");
      return;
    }

    const cur = list[idx];
    const remaining = (total - 1) - idx;

    prevBtn.disabled = (idx === 0);
    nextBtn.disabled = (idx === total - 1);

    const packTag = (Array.isArray(pack) && pack.length)
      ? `<span class="kbd" style="border-color: rgba(255,107,107,0.28); color: var(--text);">PACOTE ATRASO</span>`
      : "";

    nowEl.innerHTML =
      `Hoje:<br/>${blocksText}${done ? " ‚úÖ" : ""}<br/>
       ${packTag ? `<br/>${packTag}<br/>` : `<br/>`}
       Agora: <b>${escapeHtml(cur.book)} ${cur.chapter}</b> ‚Ä¢ Faltam: <b>${remaining}</b>`;

    stepEl.textContent = `Cap√≠tulo ${idx+1}/${total}`;

    if (idx === total - 1){
      noticeEl.textContent = "Voc√™ est√° no √öLTIMO cap√≠tulo carregado. Depois de ler, clique ‚Äú‚úÖ Finalizei a leitura de hoje‚Äù.";
      noticeEl.classList.add("show");
    } else {
      noticeEl.classList.remove("show");
    }
  }

  const monthNames = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

  function renderAll(){
    const state = ensureStateDefaults(loadState());
    versionSelectEl.value = state.version;
    planModeEl.value = state.planMode;

    document.getElementById("chipPlan").textContent = `üìñ Plano: ${modeLabel(state.planMode)}`;

    const plan = buildPlanForYear(state);
    const container = document.getElementById("months");
    container.innerHTML = "";

    const today = new Date();
    const todayKey = ymd(today);

    updateTodayHint(plan, state, today);
    updateLateUI(state);
    updateGuidedUI(plan, state, today);

    // progresso anual
    const yearDays = [];
    const yearStart = new Date(YEAR,0,1);
    const yearEnd = new Date(YEAR,11,31);
    for (let d = new Date(yearStart); d <= yearEnd; d.setDate(d.getDate()+1)) yearDays.push(ymd(d));
    const doneCount = yearDays.filter(k => state.days?.[k]?.done).length;
    const pct = Math.round((doneCount/365)*100);

    yearProgressText.textContent = `${doneCount}/365`;
    yearBar.style.width = `${pct}%`;
    yearPct.textContent = `${pct}%`;

    if (doneCount === 0) yearSub.textContent = "Comece hoje ‚Äî um dia de cada vez.";
    else if (pct < 10) yearSub.textContent = "√ìtimo in√≠cio. Const√¢ncia vence.";
    else if (pct < 50) yearSub.textContent = "Voc√™ j√° est√° construindo um h√°bito.";
    else if (pct < 90) yearSub.textContent = "Metade do caminho (ou mais). Continue firme.";
    else yearSub.textContent = "Reta final. Voc√™ vai concluir!";

    const streak = calcStreak(state, today);
    streakText.textContent = String(streak);
    if (streak === 0) streakSub.textContent = "Marque a leitura de hoje para iniciar a sequ√™ncia.";
    else if (streak < 7) streakSub.textContent = `Boa! ${streak} dia(s) seguidos.`;
    else if (streak < 30) streakSub.textContent = `Muito bom! ${streak} dias seguidos.`;
    else streakSub.textContent = `Excelente! ${streak} dias seguidos. Isso √© disciplina.`;

    const headers = getPlanStreams(state.planMode).map(s => s.label);
    const h1 = headers[0] || "Leitura 1";
    const h2 = headers[1] || "Leitura 2";
    const h3 = headers[2] || null;

    for (let m = 0; m < 12; m++){
      const details = document.createElement("details");
      details.id = `m-${YEAR}-${pad2(m+1)}`;
      if (today.getFullYear() === YEAR && today.getMonth() === m) details.open = true;

      const summary = document.createElement("summary");
      const left = document.createElement("div");
      left.className = "monthTitle";
      left.textContent = `üìå ${monthNames[m]}`;

      const monthStats = document.createElement("div");
      monthStats.className = "badge";
      monthStats.id = `badge-${m}`;

      summary.appendChild(left);
      summary.appendChild(monthStats);


      const body = document.createElement("div");
      body.className = "monthBody";

      // Calend√°rio mensal (toque no dia para ir para a linha dele)
      const cal = document.createElement("div");
      cal.className = "monthCal";

      const calHead = document.createElement("div");
      calHead.className = "monthCalHead";
      const wd = ["Seg","Ter","Qua","Qui","Sex","S√°b","Dom"];
      for (const n of wd){
        const hd = document.createElement("div");
        hd.textContent = n;
        calHead.appendChild(hd);
      }

      const calGrid = document.createElement("div");
      calGrid.className = "monthCalGrid";

      const first = new Date(YEAR, m, 1);
      const firstCol = (first.getDay() + 6) % 7; // Monday=0
      for (let i = 0; i < firstCol; i++){
        const blank = document.createElement("div");
        blank.className = "dayBlank";
        blank.innerHTML = "&nbsp;";
        calGrid.appendChild(blank);
      }

      const lastDay = new Date(YEAR, m+1, 0).getDate();
      for (let day = 1; day <= lastDay; day++){
        const date = new Date(YEAR, m, day);
        const key = ymd(date);
        const p = plan[key] || { active:false, blocks:[], guidedList:[] };
        const done = !!state.days?.[key]?.done;
        const isLate = (key < todayKey) && !done && !!p.active;

        const b = document.createElement("button");
        b.type = "button";
        b.className = "dayBtn" + (done ? " done" : "") + (isLate ? " late" : "");
        b.dataset.datekey = key;
        if (key === todayKey) b.classList.add("today");
        b.innerHTML = `<div class="dNum">${day}</div><div class="dDot" aria-hidden="true"></div>`;
b.addEventListener("click", ()=>{
          const st = ensureStateDefaults(loadState());
          st.ui = st.ui || {};
          st.ui.selectedDay = key;
          saveState(st);
          renderAll();
          setTimeout(()=>{
            const panel = document.querySelector(`.dayPlan[data-datekey="${key}"]`);
            if (panel) panel.scrollIntoView({behavior:"smooth", block:"start"});
          }, 80);
        });

        calGrid.appendChild(b);
      }

      cal.appendChild(calHead);
      cal.appendChild(calGrid);
      body.appendChild(cal);

      // Painel: Plano do dia (cards) ‚Äî aparece ao clicar no dia do calend√°rio
      const ui = state.ui || {};
      let selectedKey = ui.selectedDay;

      // padr√£o: hoje se for deste m√™s, sen√£o dia 1 do m√™s
      if (!selectedKey){
        if (todayKey.startsWith(`${YEAR}-${pad2(m+1)}-`)) selectedKey = todayKey;
        else selectedKey = `${YEAR}-${pad2(m+1)}-01`;
      }

      // se selectedKey n√£o for deste m√™s, mostra dia 1 do m√™s atual (evita confus√£o ao abrir outro m√™s)
      if (!selectedKey.startsWith(`${YEAR}-${pad2(m+1)}-`)) selectedKey = `${YEAR}-${pad2(m+1)}-01`;

      const pSel = plan[selectedKey] || { active:false, blocks:[], guidedList:[] };
      const dayNum = Number(selectedKey.split("-")[2] || "1");
      const doneSel = !!state.days?.[selectedKey]?.done;
      const isLateSel = (selectedKey < todayKey) && !doneSel && !!pSel?.active;

      const dayPlan = document.createElement("div");
      dayPlan.className = "dayPlan";
      dayPlan.dataset.datekey = selectedKey;

      const head = document.createElement("div");
      head.className = "dayPlanHead";

      const title = document.createElement("div");
      title.className = "title";
      title.innerHTML = `üìå <span>Plano do dia <b>${dayNum}</b></span> ${
        doneSel ? `<span class="pill ok">Conclu√≠do</span>` :
        (isLateSel ? `<span class="pill late">Atrasado</span>` : `<span class="pill">Pendente</span>`)
      }`;

      const headRight = document.createElement("div");
      headRight.className = "tiny";
      headRight.style.opacity = "0.9";
      headRight.textContent = "Toque em um dia no calend√°rio para trocar.";

      head.appendChild(title);
      head.appendChild(headRight);

      const grid = document.createElement("div");
      grid.className = "dayPlanGrid";

      const blocks = (pSel.blocks || []).slice(0,3);
      for (const bb of blocks){
        const blockEl = document.createElement("div");
        blockEl.className = "dayBlock";

        const h = document.createElement("div");
        h.className = "h";
        h.innerHTML = `<span>${escapeHtml(bb.heading || "Leitura")}</span><span class="openTag">Abrir</span>`;

        const t = document.createElement("div");
        t.className = "t";
        t.textContent = bb.text || "‚Äî";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btnOpen";
        btn.textContent = "Abrir cap√≠tulo";
        btn.addEventListener("click", ()=>{
          const list = bb.list || [];
          if (!list.length) return;
          const idx = (pSel.guidedList || []).findIndex(x => x.book === list[0].book && x.chapter === list[0].chapter);
          openDayGuided(selectedKey, Math.max(0, idx));
        });

        blockEl.appendChild(h);
        blockEl.appendChild(t);
        blockEl.appendChild(btn);
        grid.appendChild(blockEl);
      }

      const meta = document.createElement("div");
      meta.className = "dayMeta";

      const checkCol = document.createElement("div");
      checkCol.innerHTML = `
        <div class="checkWrap">
          <input type="checkbox" id="done-${selectedKey}" ${doneSel ? "checked":""}/>
          <span class="tiny">${doneSel ? "Feito" : "Pendente"}</span>
        </div>
      `;

      const noteCol = document.createElement("div");
      noteCol.innerHTML = `
        <textarea class="note" id="note-${selectedKey}" placeholder="Ex.: um vers√≠culo, algo que aprendi...">${escapeHtml(state.days?.[selectedKey]?.note || "")}</textarea>
      `;

      meta.appendChild(checkCol);
      meta.appendChild(noteCol);

      dayPlan.appendChild(head);
      dayPlan.appendChild(grid);
      dayPlan.appendChild(meta);
      body.appendChild(dayPlan);

      // listeners
      dayPlan.querySelector(`#done-${cssEscape(selectedKey)}`).addEventListener("change", (e)=>{
        const st = ensureStateDefaults(loadState());
        st.days[selectedKey] = st.days[selectedKey] || {};
        st.days[selectedKey].done = !!e.target.checked;
        saveState(st);
        renderAll();
      });

      dayPlan.querySelector(`#note-${cssEscape(selectedKey)}`).addEventListener("input", (e)=>{
        const st = ensureStateDefaults(loadState());
        st.days[selectedKey] = st.days[selectedKey] || {};
        st.days[selectedKey].note = e.target.value;
        saveState(st);
      });


      const wrap = document.createElement("div");
      wrap.className = "tableWrap";

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:70px">Dia</th>
            <th>${escapeHtml(h1)}</th>
            <th>${escapeHtml(h2)}</th>
            ${h3 ? `<th>${escapeHtml(h3)}</th>` : ``}
            <th style="width:130px">Conclu√≠do</th>
            <th>Anota√ß√£o</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector("tbody");
      let monthDone = 0;

      for (let day = 1; day <= lastDay; day++){
        const date = new Date(YEAR, m, day);
        const key = ymd(date);

        const p = plan[key] || { active:false, blocks:[], guidedList:[] };
        const blocks = p.blocks || [];
        const b1 = blocks[0]?.text ?? "‚Äî";
        const b2 = blocks[1]?.text ?? "‚Äî";
        const b3 = blocks[2]?.text ?? "";

        const dayState = state.days[key] || { done:false, note:"" };
        if (dayState.done) monthDone++;

        const tr = document.createElement("tr");
        if (key === todayKey) tr.classList.add("today");

        const doneId = `done-${key}`;
        const noteId = `note-${key}`;

        tr.dataset.datekey = key;

        const mkCard = (label, text, idxStart, enabled=true)=>{
          const safeLabel = escapeHtml(label || "Leitura");
          const safeText  = escapeHtml(text || "‚Äî");
          const openTag = enabled ? `<span class="openTag">Abrir</span>` : `<span class="openTag" style="opacity:.65">‚Äî</span>`;
          const disabledClass = enabled ? "" : " disabled";
          return `
            <div class="readCard${disabledClass}" data-datekey="${key}" data-idx="${idxStart}" role="button" tabindex="0" aria-label="Abrir ${safeLabel}">
              <div class="lbl">${safeLabel} ${openTag}</div>
              <div class="txt">${safeText}</div>
            </div>
          `;
        };

        // √≠ndice inicial de cada bloco dentro do guidedList do dia
        const idx1 = (blocks[0]?.list?.length)
          ? (p.guidedList || []).findIndex(x => x.book === blocks[0].list[0].book && x.chapter === blocks[0].list[0].chapter)
          : 0;
        const idx2 = (blocks[1]?.list?.length)
          ? (p.guidedList || []).findIndex(x => x.book === blocks[1].list[0].book && x.chapter === blocks[1].list[0].chapter)
          : 0;
        const idx3 = (blocks[2]?.list?.length)
          ? (p.guidedList || []).findIndex(x => x.book === blocks[2].list[0].book && x.chapter === blocks[2].list[0].chapter)
          : 0;

        const canOpen = p?.active && (p.guidedList || []).length;

        tr.innerHTML = `
          <td class="dayCell">${day}</td>
          <td class="readCell">${mkCard(h1, b1, Math.max(0, idx1), canOpen)}</td>
          <td class="readCell">${mkCard(h2, b2, Math.max(0, idx2), canOpen)}</td>
          ${h3 ? `<td class="readCell">${mkCard(h3, (b3 || "‚Äî"), Math.max(0, idx3), canOpen)}</td>` : ``}
          <td>
            <div class="checkWrap">
              <input type="checkbox" id="${doneId}" ${dayState.done ? "checked":""} />
              <span class="tiny">${dayState.done ? "Feito" : "Pendente"}</span>
            </div>
          </td>
          <td>
            <textarea class="note" id="${noteId}" placeholder="Ex.: um vers√≠culo, algo que aprendi...">${escapeHtml(dayState.note || "")}</textarea>
          </td>
        `;

        tbody.appendChild(tr);

        tr.querySelector(`#${cssEscape(doneId)}`).addEventListener("change", (e)=>{
          const s = ensureStateDefaults(loadState());
          s.days[key] = s.days[key] || {};
          s.days[key].done = !!e.target.checked;
          saveState(s);
          renderAll();
        });

        tr.querySelector(`#${cssEscape(noteId)}`).addEventListener("input", (e)=>{
          const s = ensureStateDefaults(loadState());
          s.days[key] = s.days[key] || {};
          s.days[key].note = e.target.value;
          saveState(s);
        });

        // Abrir leitura ao tocar no card (abre direto no cap√≠tulo)
        tr.querySelectorAll(".readCard").forEach((card)=>{
          const open = ()=>{
            if (card.classList.contains("disabled")) return;
            const dk = card.getAttribute("data-datekey");
            const idx = Number(card.getAttribute("data-idx") || "0");
            openDayGuided(dk, idx);
          };
          card.addEventListener("click", open);
          card.addEventListener("keydown", (e)=>{
            if (e.key === "Enter" || e.key === " "){
              e.preventDefault();
              open();
            }
          });
        });
      }

      wrap.appendChild(table);
      body.appendChild(wrap);

      details.appendChild(summary);
      details.appendChild(body);
      container.appendChild(details);

      const monthTotal = lastDay;
      const pctM = Math.round((monthDone/monthTotal)*100);
      document.getElementById(`badge-${m}`).textContent = `‚úÖ ${monthDone}/${monthTotal} (${pctM}%)`;
    }
  }

  // DOM
  const versionSelectEl = document.getElementById("versionSelect");
  const planModeEl = document.getElementById("planMode");

  const yearProgressText = document.getElementById("yearProgressText");
  const yearBar = document.getElementById("yearBar");
  const yearPct = document.getElementById("yearPct");
  const yearSub = document.getElementById("yearSub");

  const streakText = document.getElementById("streakText");
  const streakSub = document.getElementById("streakSub");

  // Events
  document.getElementById("applyBtn").addEventListener("click", ()=>{
    const state = ensureStateDefaults(loadState());
    state.version = versionSelectEl.value || DEFAULT_VERSION;
    state.planMode = planModeEl.value || DEFAULT_MODE;
    saveState(state);
    renderAll();
  });

  document.getElementById("openTodayBtn").addEventListener("click", ()=>{
    const t = new Date();
    const targetMonth = (t.getFullYear() === YEAR) ? (t.getMonth()+1) : 1;
    const el = document.getElementById(`m-${YEAR}-${pad2(targetMonth)}`);
    if (el){ el.open = true; el.scrollIntoView({behavior:"smooth", block:"start"}); }
  });

  document.getElementById("fabToday").addEventListener("click", goToToday);

  document.getElementById("guidedStartBtn").addEventListener("click", ()=> openGuidedAtIndex(0));
  document.getElementById("catchUpBtn").addEventListener("click", openCatchUpPack);

  document.getElementById("guidedPrevBtn").addEventListener("click", ()=>{
    const s = ensureStateDefaults(loadState());
    const today = new Date();
    if (today.getFullYear() !== YEAR) return;
    const key = ymd(today);
    const idx = getGuidedIndex(s, key);
    openGuidedAtIndex(idx - 1);
  });
  document.getElementById("guidedNextBtn").addEventListener("click", ()=>{
    const s = ensureStateDefaults(loadState());
    const today = new Date();
    if (today.getFullYear() !== YEAR) return;
    const key = ymd(today);
    const idx = getGuidedIndex(s, key);
    openGuidedAtIndex(idx + 1);
  });
  document.getElementById("guidedFinishBtn").addEventListener("click", finishTodayReading);

  document.getElementById("startTodayReadingBtn").addEventListener("click", ()=> openGuidedAtIndex(0));
  document.getElementById("finishTodayBtn").addEventListener("click", finishTodayReading);

  versionSelectEl.addEventListener("change", ()=>{
    const s = ensureStateDefaults(loadState());
    s.version = versionSelectEl.value || DEFAULT_VERSION;
    saveState(s);
    renderAll();
  });

  planModeEl.addEventListener("change", ()=>{
    const s = ensureStateDefaults(loadState());
    s.planMode = planModeEl.value || DEFAULT_MODE;
    saveState(s);
    renderAll();
  });

  // init
  renderAll();

  // === LEITOR B√çBLICO INTERNO (texto via API) ===
  function normalizeBookName(str){
    return (str||"")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9 ]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }
  function apiBookName(ptName){
    const k = normalizeBookName(ptName);
    const map = {
      "genesis":"Genesis","exodo":"Exodus","levitico":"Leviticus","numeros":"Numbers","deuteronomio":"Deuteronomy",
      "josue":"Joshua","juizes":"Judges","rute":"Ruth",
      "1 samuel":"1 Samuel","2 samuel":"2 Samuel","1 reis":"1 Kings","2 reis":"2 Kings",
      "1 cronicas":"1 Chronicles","2 cronicas":"2 Chronicles","esdras":"Ezra","neemias":"Nehemiah","ester":"Esther",
      "jo":"Job","salmos":"Psalms","proverbios":"Proverbs","eclesiastes":"Ecclesiastes","canticos":"Song of Solomon","cantares":"Song of Solomon",
      "isaias":"Isaiah","jeremias":"Jeremiah","lamentacoes":"Lamentations","ezequiel":"Ezekiel","daniel":"Daniel",
      "oseias":"Hosea","joel":"Joel","amos":"Amos","obadias":"Obadiah","jonas":"Jonah","miqueias":"Micah",
      "naum":"Nahum","habacuque":"Habakkuk","sofonias":"Zephaniah","ageu":"Haggai","zacarias":"Zechariah","malaquias":"Malachi",
      "mateus":"Matthew","marcos":"Mark","lucas":"Luke","joao":"John","atos":"Acts",
      "romanos":"Romans","1 corintios":"1 Corinthians","2 corintios":"2 Corinthians","galatas":"Galatians","efesios":"Ephesians",
      "filipenses":"Philippians","colossenses":"Colossians","1 tessalonicenses":"1 Thessalonians","2 tessalonicenses":"2 Thessalonians",
      "1 timoteo":"1 Timothy","2 timoteo":"2 Timothy","tito":"Titus","filemom":"Philemon",
      "hebreus":"Hebrews","tiago":"James","1 pedro":"1 Peter","2 pedro":"2 Peter",
      "1 joao":"1 John","2 joao":"2 John","3 joao":"3 John","judas":"Jude",
      "apocalipse":"Revelation"
    };
    return map[k] || ptName;
  }

  
  // === LEITOR B√çBLICO INTERNO (bible-api.com /data) ‚Äî Portugu√™s (almeida) ===
  function normalizeBookName(str){
    return (str||"")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9 ]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }
  function getBookId(ptName){
    const k = normalizeBookName(ptName);
    const map = {"genesis": "GEN", "exodo": "EXO", "levitico": "LEV", "numeros": "NUM", "deuteronomio": "DEU", "josue": "JOS", "juizes": "JDG", "rute": "RUT", "1 samuel": "1SA", "2 samuel": "2SA", "1 reis": "1KI", "2 reis": "2KI", "1 cronicas": "1CH", "2 cronicas": "2CH", "esdras": "EZR", "neemias": "NEH", "ester": "EST", "jo": "JOB", "salmos": "PSA", "proverbios": "PRO", "eclesiastes": "ECC", "canticos": "SNG", "cantares": "SNG", "isaias": "ISA", "jeremias": "JER", "lamentacoes": "LAM", "ezequiel": "EZK", "daniel": "DAN", "oseias": "HOS", "joel": "JOL", "amos": "AMO", "obadias": "OBA", "jonas": "JON", "miqueias": "MIC", "naum": "NAM", "habacuque": "HAB", "sofonias": "ZEP", "ageu": "HAG", "zacarias": "ZEC", "malaquias": "MAL", "mateus": "MAT", "marcos": "MRK", "lucas": "LUK", "joao": "JHN", "atos": "ACT", "romanos": "ROM", "1 corintios": "1CO", "2 corintios": "2CO", "galatas": "GAL", "efesios": "EPH", "filipenses": "PHP", "colossenses": "COL", "1 tessalonicenses": "1TH", "2 tessalonicenses": "2TH", "1 timoteo": "1TI", "2 timoteo": "2TI", "tito": "TIT", "filemom": "PHM", "hebreus": "HEB", "tiago": "JAS", "1 pedro": "1PE", "2 pedro": "2PE", "1 joao": "1JN", "2 joao": "2JN", "3 joao": "3JN", "judas": "JUD", "apocalipse": "REV"};
    return map[k] || null;
  }

    // Contexto da leitura atual para navega√ß√£o no plano
  let currentReadingCtx = null;

  function openBibleReader(book, chapter, ctx){
    const modal = document.getElementById("readerModal");
    const textEl = document.getElementById("readerText");
    const loading = document.getElementById("readerLoading");
    const errEl = document.getElementById("readerError");
    const refEl = document.getElementById("readerRef");
    const extBtn = document.getElementById("readerExternalBtn");

    textEl.innerHTML = "";
    errEl.style.display = "none";
    errEl.textContent = "";
    loading.style.display = "block";

    const st = ensureStateDefaults(loadState());
    const translationId = "almeida"; // sempre PT no leitor interno
    refEl.textContent = `${book} ${chapter} ‚Äî ${translationId.toUpperCase()}`;

    modal.classList.add("open");

    // registra contexto para "Pr√≥ximo/Anterior no plano"
    if (ctx) currentReadingCtx = ctx;
    updatePlanNavButtons();

    modal.setAttribute("aria-hidden","false");

    // Externo: respeita a tradu√ß√£o escolhida no app (ACF/ARA/etc) no BibleOnline
    extBtn.onclick = ()=>{
      const url = bibleOnlineUrl(st.translation, book, chapter);
      window.open(url, READING_WINDOW_NAME, "noopener,noreferrer");
    };

    const bookId = getBookId(book);
    if (!bookId){
      loading.style.display = "none";
      errEl.style.display = "block";
      errEl.textContent = `Livro n√£o reconhecido para leitura interna: "${book}".\n\nUse ‚ÄúAbrir externo‚Äù.`;
      return;
    }

    const url = `https://bible-api.com/data/${translationId}/${bookId}/${chapter}`;

    fetch(url)
      .then(r => r.json())
      .then(data => {
        // Estrutura do /data geralmente traz "verses" com "verse" e "text"
        const verses = data && (data.verses || data);
        if (!Array.isArray(verses) || !verses.length){
          loading.style.display = "none";
          errEl.style.display = "block";
          const msg = data?.error || data?.message || "Resposta sem versos.";
          errEl.textContent = `N√£o foi poss√≠vel carregar o texto.\n\nDetalhe: ${msg}\nURL: ${url}\n\nUse ‚ÄúAbrir externo‚Äù.`;
          return;
        }
        loading.style.display = "none";
        
            textEl.innerHTML = verses.map(v => {
              const n = v.verse ?? v.verse_id ?? v.number ?? "";
              const t = v.text ?? v.t ?? "";
              return `<p class="verse" data-verse="${n}"><b>${n}</b> ${escapeHtml(String(t))}</p>`;
            }).join("");
const keyRef = `${book}|${chapter}|${translationId}`;
            const st2 = ensureStateDefaults(loadState());
            st2.reader = st2.reader || {};
            st2.reader.highlights = st2.reader.highlights || {};
            st2.reader.last = st2.reader.last || {};
            const hlSet = new Set(st2.reader.highlights[keyRef] || []);

            const versesEls = Array.from(textEl.querySelectorAll(".verse"));
            versesEls.forEach(el=>{
              const vn = String(el.dataset.verse || "");
              if (!el.getAttribute("data-original")) el.setAttribute("data-original", el.innerHTML);
              if (hlSet.has(vn)) el.classList.add("hl");

              el.addEventListener("click", ()=>{
                const st3 = ensureStateDefaults(loadState());
                st3.reader = st3.reader || {};
                st3.reader.highlights = st3.reader.highlights || {};
                st3.reader.hlText = st3.reader.hlText || {};
                st3.reader.hlText[keyRef] = st3.reader.hlText[keyRef] || {};
                const arr = st3.reader.highlights[keyRef] || [];
                const set = new Set(arr);
                if (set.has(vn)){
                  set.delete(vn);
                  el.classList.remove("hl");
                  try{ delete st3.reader.hlText[keyRef][vn]; }catch(e){}
                } else {
                  set.add(vn);
                  el.classList.add("hl");
                  try{ st3.reader.hlText[keyRef][vn] = (el.textContent || "").trim(); }catch(e){}
                }
                st3.reader.highlights[keyRef] = Array.from(set);
                saveState(st3);
              });
            });

            // Busca com realce
            const searchInput = document.getElementById("readerSearch");
            const clearSearchBtn = document.getElementById("readerClearSearchBtn");
            const clearHlBtn = document.getElementById("readerClearHighlightsBtn");

            const clearMarks = ()=>{
              versesEls.forEach(el=>{
                const orig = el.getAttribute("data-original");
                if (orig) el.innerHTML = orig;
              });
            };

            const applySearch = (q)=>{
              clearMarks();
              const query = (q||"").trim().toLowerCase();
              if (!query) return;

              let firstHit = null;
              versesEls.forEach(el=>{
                const txt = el.textContent.toLowerCase();
                if (txt.includes(query)){
                  const orig = el.getAttribute("data-original");
                  if (!orig) return;
                  const parts = orig.split("</b>");
                  if (parts.length >= 2){
                    const head = parts[0] + "</b>";
                    const body = parts.slice(1).join("</b>");
                    const esc = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
                    const reQ = new RegExp(esc, "gi");
                    const bodyMarked = body.replace(reQ, (m)=>`<mark class="readerMark">${m}</mark>`);
                    el.innerHTML = head + bodyMarked;
                  }
                  if (!firstHit) firstHit = el;
                }
              });
              if (firstHit){
                firstHit.scrollIntoView({behavior:"smooth", block:"center"});
              }
            };

            searchInput.oninput = ()=> applySearch(searchInput.value);

            clearSearchBtn.onclick = ()=>{
              searchInput.value = "";
              clearMarks();
              searchInput.focus();
            };

            clearHlBtn.onclick = ()=>{
              const st4 = ensureStateDefaults(loadState());
              st4.reader = st4.reader || {};
              st4.reader.highlights = st4.reader.highlights || {};
              st4.reader.highlights[keyRef] = [];
              st4.reader.hlText = st4.reader.hlText || {};
              st4.reader.hlText[keyRef] = {};
              saveState(st4);
              versesEls.forEach(el=> el.classList.remove("hl"));
            };

            // √öltimo vers√≠culo lido (mais pr√≥ximo do topo do scroll)
            const bodyEl = modal.querySelector(".readerBody");
            const setActive = (vn)=>{
              versesEls.forEach(el=> el.classList.toggle("active", String(el.dataset.verse||"")===String(vn)));
            };
            const saveLast = (vn)=>{
              const st5 = ensureStateDefaults(loadState());
              st5.reader = st5.reader || {};
              st5.reader.last = st5.reader.last || {};
              st5.reader.last[keyRef] = String(vn);
              saveState(st5);
            };

            let raf = null;
            const computeTopVerse = ()=>{
              raf = null;
              const topY = bodyEl.getBoundingClientRect().top + 140;
              let best = null, bestDist = Infinity;
              for (const el of versesEls){
                const r = el.getBoundingClientRect();
                const d = Math.abs(r.top - topY);
                if (d < bestDist){ bestDist = d; best = el; }
              }
              if (best){
                const vn = best.dataset.verse || "";
                setActive(vn);
                saveLast(vn);
              }
            };

            bodyEl.addEventListener("scroll", ()=>{
              if (raf) return;
              raf = requestAnimationFrame(computeTopVerse);
            });

            // Restaurar √∫ltimo vers√≠culo salvo
            const lastVN = st2.reader.last[keyRef];
            if (lastVN){
              const lastEl = textEl.querySelector(`.verse[data-verse="${CSS.escape(String(lastVN))}"]`);
              if (lastEl){
                setTimeout(()=> lastEl.scrollIntoView({behavior:"smooth", block:"center"}), 80);
                setActive(lastVN);
              } else {
                computeTopVerse();
              }
            } else {
              computeTopVerse();
            }

      })
      .catch((e)=>{
        loading.style.display = "none";
        errEl.style.display = "block";
        errEl.textContent = `Erro ao carregar o texto.\n\nDetalhe: ${String(e)}\nURL: ${url}\n\nUse ‚ÄúAbrir externo‚Äù.`;
      });
  }

  function updatePlanNavButtons(){
    const prevBtn = document.getElementById("readerPlanPrevBtn");
    const nextBtn = document.getElementById("readerPlanNextBtn");
    if (!prevBtn || !nextBtn) return;

    if (!currentReadingCtx || !currentReadingCtx.list){
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      return;
    }
    const idx = Number(currentReadingCtx.idx || 0);
    prevBtn.disabled = idx <= 0;
    nextBtn.disabled = idx >= (currentReadingCtx.list.length - 1);
  }

  function goPlanDelta(delta){
    if (!currentReadingCtx || !currentReadingCtx.list) return;
    const nextIdx = Number(currentReadingCtx.idx || 0) + delta;
    if (nextIdx < 0 || nextIdx >= currentReadingCtx.list.length) return;

    const item = currentReadingCtx.list[nextIdx];
    // Atualiza √≠ndice e abre a pr√≥xima leitura do plano no leitor interno
    currentReadingCtx.idx = nextIdx;

    // Se existir chave de dia (para manter o progresso guiado do dia), atualiza tamb√©m
    if (currentReadingCtx.dateKey){
      try{
        const st = ensureStateDefaults(loadState());
        setGuidedIndex(st, currentReadingCtx.dateKey, nextIdx);
        saveState(st);
      }catch(e){}
    }

    openBibleReader(item.book, item.chapter, currentReadingCtx);
  }


function closeReader(){
    const modal = document.getElementById("readerModal");
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden","true");
    document.getElementById("readerText").innerHTML = "";
    document.getElementById("readerError").style.display = "none";
    document.getElementById("readerLoading").style.display = "none";
  
    try{ const s = document.getElementById("readerSearch"); if (s) s.value=""; }catch(e){}
    updatePlanNavButtons();
  }

  document.getElementById("readerCloseBtn").addEventListener("click", closeReader);
  document.getElementById("readerPlanPrevBtn").addEventListener("click", ()=>goPlanDelta(-1));
  document.getElementById("readerPlanNextBtn").addEventListener("click", ()=>goPlanDelta(1));

  document.getElementById("readerModal").addEventListener("click", (e)=>{ if (e.target.id === "readerModal") closeReader(); });
  window.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && document.getElementById("readerModal").classList.contains("open")) closeReader(); });


  // === DI√ÅRIO DO DIA (Resumo + Vers√≠culo do dia) ===
  let currentDiaryDayKey = null;

  function openDiaryForDay(dateKey){
    const modal = document.getElementById("diaryModal");
    const refEl = document.getElementById("diaryRef");
    const summaryEl = document.getElementById("diarySummary");
    const versesWrap = document.getElementById("diaryVerses");
    const hintEl = document.getElementById("diaryHint");

    currentDiaryDayKey = dateKey;

    const st = ensureStateDefaults(loadState());
    st.reader = st.reader || {};
    st.reader.diary = st.reader.diary || {};

    const entry = st.reader.diary[dateKey] || {};
    summaryEl.value = entry.summary || "";

    const labelDay = (dateKey||"").replace("2026-","") || dateKey;
    refEl.textContent = `Dia ${labelDay} ‚Äî Di√°rio`;

    const planBlocks = (getPlanForDate(dateKey) || []);
    const items = planBlocks.flatMap(p => (p.list || []));
    const translationId = "almeida";
    const hl = st.reader.highlights || {};
    const hlText = st.reader.hlText || {};

    const candidates = [];
    for (const it of items){
      const keyRef = `${it.book}|${it.chapter}|${translationId}`;
      const arr = hl[keyRef] || [];
      const textMap = hlText[keyRef] || {};
      for (const vn of arr){
        const full = textMap[vn] || `${it.book} ${it.chapter}:${vn}`;
        candidates.push({
          book: it.book,
          chapter: it.chapter,
          verse: String(vn),
          displayRef: `${it.book} ${it.chapter}:${vn}`,
          text: full
        });
      }
    }

    versesWrap.innerHTML = "";
    delete versesWrap.dataset.selectedRef;
    delete versesWrap.dataset.selectedText;

    if (!candidates.length){
      hintEl.style.display = "block";
      versesWrap.innerHTML = `<div class="diaryHint">Nenhum destaque encontrado para este dia. Abra o cap√≠tulo e clique no vers√≠culo para destacar.</div>`;
    } else {
      hintEl.style.display = "block";
      const selectedRef = entry.verseRef || "";
      candidates.forEach(c=>{
        const div = document.createElement("div");
        div.className = "diaryVerse" + (c.displayRef === selectedRef ? " selected" : "");
        div.innerHTML = `
          <div class="diaryVerseTop">
            <div class="diaryVerseRef">${escapeHtml(c.displayRef)}</div>
          </div>
          <div class="diaryVerseText">${escapeHtml(c.text)}</div>
        `;
        div.addEventListener("click", ()=>{
          Array.from(versesWrap.querySelectorAll(".diaryVerse")).forEach(x=>x.classList.remove("selected"));
          div.classList.add("selected");
          versesWrap.dataset.selectedRef = c.displayRef;
          versesWrap.dataset.selectedText = c.text;
        });
        versesWrap.appendChild(div);
      });

      if (selectedRef){
        versesWrap.dataset.selectedRef = selectedRef;
        versesWrap.dataset.selectedText = entry.verseText || "";
      }
    }

    modal.classList.add("open");
    modal.setAttribute("aria-hidden","false");
  }

  function closeDiary(){
    const modal = document.getElementById("diaryModal");
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden","true");
  }

  document.getElementById("diaryCloseBtn").addEventListener("click", closeDiary);
  document.getElementById("diaryModal").addEventListener("click", (e)=>{ if (e.target.id === "diaryModal") closeDiary(); });

  document.getElementById("diaryRefreshBtn").addEventListener("click", ()=>{
    if (currentDiaryDayKey) openDiaryForDay(currentDiaryDayKey);
  });

  document.getElementById("diarySaveBtn").addEventListener("click", ()=>{
    if (!currentDiaryDayKey) return;
    const st = ensureStateDefaults(loadState());
    st.reader = st.reader || {};
    st.reader.diary = st.reader.diary || {};

    const summary = (document.getElementById("diarySummary").value || "").trim();
    const versesWrap = document.getElementById("diaryVerses");
    const verseRef = versesWrap.dataset.selectedRef || (st.reader.diary[currentDiaryDayKey]?.verseRef || "");
    const verseText = versesWrap.dataset.selectedText || (st.reader.diary[currentDiaryDayKey]?.verseText || "");

    st.reader.diary[currentDiaryDayKey] = { summary, verseRef, verseText, updatedAt: new Date().toISOString() };
    saveState(st);
    closeDiary();
    try{ renderAll(); }catch(e){}
  });

</script>
</body>
</html>
